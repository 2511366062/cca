---
title: "èŠ¯ç‰‡æ•°æ®åˆ†æ"
author: "lixiaokang"
date: "2025-04-18"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}

#æ‰“ç ´ä¸‹è½½æ—¶é—´çš„é™åˆ¶,æ”¹å‰60ç§’ï¼Œæ”¹å10wç§’
#optionså¼€å¤´çš„éƒ½æ˜¯è®¾ç½®
options(timeout = 100000) 
options(scipen = 20)#ä¸è¦ä»¥ç§‘å­¦è®¡æ•°æ³•è¡¨ç¤º

#ä¼ ç»Ÿä¸‹è½½æ–¹å¼
library(GEOquery)
eSet = getGEO("GSE26511", destdir = '.', getGPL = F)
library(AnnoProbe)
eSet = geoChina("GSE26511")
eSet = eSet[[1]] #å–å‡ºå…ƒç´ ï¼ŒåªåŒ…å«ä¸€ä¸ª
class(eSet)
exp = eSet@assayData$exprs
range(exp) # #çœ‹æ•°æ®èŒƒå›´å†³å®šæ˜¯å¦éœ€è¦logï¼Œä¸­ä½æ•°æ˜¯åœ¨0é™„è¿‘ï¼Œå¼‚å¸¸å€¼ï¼ˆè´Ÿæ•°å¾ˆå¤šï¼Œ-5ï½5ï¼Œå¾ˆå¤§å¾ˆå¤§ï¼‰ï¼Œæ­£å¸¸å€¼ï¼ˆï¼Œå°‘é‡è´Ÿå€¼ï¼Œæœ‰äº›logæ²¡+1ï¼›0-20ï¼‰
boxplot(exp,las = 2)


#ä¸´åºŠä¿¡æ¯
pd = pData(eSet)

#pdçš„è¡Œåä¸expçš„åˆ—åå®Œå…¨ä¸€è‡´
p = identical(rownames(pd),colnames(exp));p
if(!p) {
  s = intersect(rownames(pd),colnames(exp))
  exp = exp[,s]
  pd = pd[s,]
}

#(4)æå–èŠ¯ç‰‡å¹³å°ç¼–å·ï¼Œåé¢è¦æ ¹æ®å®ƒæ¥æ‰¾æ¢é’ˆæ³¨é‡Š
gpl_number <- eSet@annotation;gpl_number
save(pd,exp,gpl_number,file = "Aarrayoutput.Rdata")

```

## æ¢é’ˆæ³¨é‡Š

```{r}
# Group(å®éªŒåˆ†ç»„)å’Œids(æ¢é’ˆæ³¨é‡Š)
rm(list = ls())  
load(file = "Aarrayoutput.Rdata")
# 1.Group----
library(stringr)
# æ ‡å‡†æµç¨‹ä»£ç æ˜¯äºŒåˆ†ç»„ï¼Œå¤šåˆ†ç»„æ•°æ®çš„åˆ†æåé¢å¦è®²
# ç”ŸæˆGroupå‘é‡çš„ä¸‰ç§å¸¸è§„æ–¹æ³•ï¼Œä¸‰é€‰ä¸€ï¼Œé€‰è°å°±æŠŠç¬¬å‡ ä¸ªé€»è¾‘å€¼å†™æˆTï¼Œå¦å¤–ä¸¤ä¸ªä¸ºFã€‚å¦‚æœä¸‰ç§åŠæ³•éƒ½ä¸é€‚ç”¨ï¼Œå¯ä»¥ç»§ç»­å¾€åå†™else if
if(F){
  # ç¬¬ä¸€ç§æ–¹æ³•ï¼Œæœ‰ç°æˆçš„å¯ä»¥ç”¨æ¥åˆ†ç»„çš„åˆ—
  
}else if(F){
  # ç¬¬äºŒç§æ–¹æ³•ï¼Œçœ¼ç›æ•°ï¼Œè‡ªå·±ç”Ÿæˆ
  Group = rep(c("Disease","Normal"),each = 10)
  # repå‡½æ•°çš„å…¶ä»–ç”¨æ³•ï¼Ÿç›¸é—´ã€ä¸¤ç»„çš„æ•°é‡ä¸åŒï¼Ÿ
}else if(T){
  # ç¬¬ä¸‰ç§æ–¹æ³•ï¼Œä½¿ç”¨å­—ç¬¦ä¸²å¤„ç†çš„å‡½æ•°è·å–åˆ†ç»„
  k = str_detect(pd$title,"negative");table(k)
  Group = ifelse(k,"negative","positive")   
}

# éœ€è¦æŠŠGroupè½¬æ¢æˆå› å­ï¼Œå¹¶è®¾ç½®å‚è€ƒæ°´å¹³ï¼ŒæŒ‡å®šlevelsï¼Œå¯¹ç…§ç»„åœ¨å‰ï¼Œå¤„ç†ç»„åœ¨å
Group = factor(Group,levels = c("negative","positive"))
levels(Group) = c("normal","turned")
Group

#2.æ¢é’ˆæ³¨é‡Šçš„è·å–-----------------
#æ·å¾„
library(tinyarray)
find_anno(gpl_number) #è¾…åŠ©å†™å‡ºæ‰¾æ³¨é‡Šçš„ä»£ç 
library(hgu133plus2.db);ids <- toTable(hgu133plus2SYMBOL)
#idsss <- AnnoProbe::idmap('GPL570')
#è¿™æ˜¯ä»28è¡Œè¿è¡Œç»“æœé‡Œå¤åˆ¶ä¸‹æ¥çš„ä»£ç ğŸ‘†
#å¦‚æœèƒ½æ‰“å‡ºä»£ç å°±ä¸éœ€è¦å†ç®¡å…¶ä»–æ–¹æ³•ã€‚
#å¦‚æœä½¿ç”¨å¤åˆ¶ä¸‹æ¥çš„AnnoProbe::idmap('xxx')ä»£ç å‘ç°æŠ¥é”™äº†ï¼Œè¯·æ³¨æ„å°è¯•ä¸åŒçš„typeå‚æ•°
#å¦‚æœæ˜¾ç¤ºno annotation avliable in Bioconductor and AnnoProbeåˆ™è¦å»GEOç½‘é¡µä¸Šçœ‹GPLè¡¨æ ¼é‡Œæ‰¾å•¦ã€‚

#å››ç§æ–¹æ³•ï¼Œæ–¹æ³•1é‡Œæ‰¾ä¸åˆ°å°±ä»æ–¹æ³•2æ‰¾ï¼Œä»¥æ­¤ç±»æ¨ã€‚
#æ·å¾„é‡Œé¢åŒ…å«äº†å…¨éƒ¨çš„RåŒ…ã€ä¸€éƒ¨åˆ†è¡¨æ ¼ã€ä¸€éƒ¨åˆ†è‡ªä¸»æ³¨é‡Š
#æ–¹æ³•1 BioconductorRåŒ…(æœ€å¸¸ç”¨ï¼Œå·²å…¨éƒ¨æ”¶å…¥find_annoé‡Œé¢ï¼Œä¸ç”¨çœ‹å•¦)
if(F){
  gpl_number #çœ‹çœ‹ç¼–å·æ˜¯å¤šå°‘
  #http://www.bio-info-trainee.com/1399.html #åœ¨è¿™é‡Œæœç´¢ï¼Œæ‰¾åˆ°å¯¹åº”çš„RåŒ…
  library(hgu133plus2.db)
  ls("package:hgu133plus2.db") #åˆ—å‡ºRåŒ…é‡Œéƒ½æœ‰å•¥
  ids <- toTable(hgu133plus2SYMBOL) #æŠŠRåŒ…é‡Œçš„æ³¨é‡Šè¡¨æ ¼å˜æˆæ•°æ®æ¡†
}
# æ–¹æ³•2 è¯»å–GPLç½‘é¡µçš„è¡¨æ ¼æ–‡ä»¶ï¼ŒæŒ‰åˆ—å–å­é›†
##https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GPL570
# æ–¹æ³•3 å®˜ç½‘ä¸‹è½½æ³¨é‡Šæ–‡ä»¶å¹¶è¯»å–
# æ–¹æ³•4 è‡ªä¸»æ³¨é‡Šï¼Œäº†è§£ä¸€ä¸‹
#https://mp.weixin.qq.com/s/mrtjpN8yDKUdCSvSUuUwcA
save(exp,Group,ids,file = "Rdata/Array2output.Rdata")



```


### èŠ¯ç‰‡æ•°æ®å·®å¼‚åˆ†æ
```{r}
dat=as.data.frame(t(exp)) #è½¬ç½®è¡¨è¾¾çŸ©é˜µ
library(FactoMineR)
library(factoextra) 
dat.pca <- PCA(dat, graph = FALSE)
fviz_pca_ind(dat.pca,
             geom.ind = "point", # show points only (nbut not "text")
             col.ind = Group, # color by groups
             palette = c("#00AFBB", "#E7B800"),
             addEllipses = TRUE, # Concentration ellipses
             legend.title = "Groups"
)


```

## å‰æ ‡å‡†å·®å‰1000çš„åŸºå› 


```{r}

# 2.top 1000 sd çƒ­å›¾---- 
g = names(tail(sort(apply(exp,1,sd)),1000)) #å–æ ‡å‡†å·®æœ€å¤§çš„å‰1000ä¸ªåŸºå› çš„æ¢é’ˆid
n = exp[g,]#å–å‡ºè¿™1000ä¸ªåŸºå› çš„è¡¨è¾¾çŸ©é˜µ
library(pheatmap)
annotation_col = data.frame(row.names = colnames(n),
                            Group = Group)#è§è¯´æ˜ä»£ç è¯´æ˜
pheatmap(n,
         show_colnames =F,#éšè—æ ·æœ¬å
         show_rownames = F,#éšè—åŸºå› å
         annotation_col=annotation_col,#åˆ†ç»„ä¿¡æ¯ï¼šæ ·æœ¬åå’Œåˆ†ç»„åå¯¹åº”
         scale = "row", #æŒ‰è¡Œæ ‡å‡†åŒ–ï¼Œåªä¿ç•™è¡Œå†…å·®åˆ«ï¼Œä¸ä¿ç•™è¡Œé—´å·®åˆ«ï¼Œä¼šæŠŠæ•°æ®èŒƒå›´ç¼©æ”¾åˆ°å¤§æ¦‚-5~5ä¹‹é—´,å·®å¼‚åŸºå› æ˜¯è¡Œé—´çš„æ¯”è¾ƒ
         breaks = seq(-3,3,length.out = 100) #è®¾ç½®è‰²å¸¦åˆ†å¸ƒèŒƒå›´ä¸º-3~3ä¹‹é—´ï¼Œè¶…å‡ºæ­¤èŒƒå›´çš„æ•°å­—æ˜¾ç¤ºæé™é¢œè‰²
         ) 


```
## èŠ¯ç‰‡æ•°æ®å·®å¼‚åˆ†æ

```{r}

library(limma)
design = model.matrix(~Group)
fit = lmFit(exp,design)
fit = eBayes(fit)
deg = topTable(fit,coef = 2,number = Inf)

# 1.æ¢é’ˆåˆ—
library(dplyr)
deg = mutate(deg,probe_id = rownames(deg))


#2.åŠ ä¸Šæ¢é’ˆæ³¨é‡Š
ids = distinct(ids,symbol,.keep_all = T)
deg = inner_join(deg,ids,by="probe_id")
nrow(deg) #å¦‚æœè¡Œæ•°ä¸º0å°±æ˜¯ä½ æ‰¾çš„æ¢é’ˆæ³¨é‡Šæ˜¯é”™çš„ã€‚


## 3.æ·»åŠ changeåˆ—ï¼Œæ ‡è®°ä¸Šä¸‹è°ƒã€æ— å˜åŒ–åŸºå› 
logFC_t = 1
p_t = 0.05
#æ€è€ƒï¼Œå¦‚ä½•ä½¿ç”¨padjè€Œépå€¼
k1 = (deg$P.Value < p_t)&(deg$logFC < -logFC_t)
k2 = (deg$P.Value < p_t)&(deg$logFC > logFC_t)
deg = mutate(deg,change = ifelse(k1,"down",ifelse(k2,"up","stable")))


#4.åŠ ENTREZIDåˆ—ï¼Œç”¨äºå¯Œé›†åˆ†æï¼ˆsymbolè½¬entrezidï¼Œç„¶åinner_joinï¼‰
library(clusterProfiler)
library(org.Hs.eg.db)
s2e = bitr(deg$symbol, 
           fromType = "SYMBOL",
           toType = "ENTREZID",
           OrgDb = org.Hs.eg.db)#äººç±»,æ³¨æ„ç‰©ç§
#ä¸€éƒ¨åˆ†åŸºå› æ²¡åŒ¹é…ä¸Šæ˜¯æ­£å¸¸çš„ã€‚<30%çš„å¤±è´¥éƒ½æ²¡äº‹ã€‚
#å…¶ä»–ç‰©ç§http://bioconductor.org/packages/release/BiocViews.html#___OrgDb
nrow(deg)
deg = inner_join(deg,s2e,by=c("symbol"="SYMBOL"))
#å¤šäº†å‡ è¡Œå°‘äº†å‡ è¡Œéƒ½æ­£å¸¸ï¼ŒSYMBOLä¸ENTREZIDä¸æ˜¯ä¸€å¯¹ä¸€çš„ã€‚


##ç«å±±å›¾
library(ggplot2)
ggplot(data = deg, aes(x = logFC, y = -log10(P.Value))) +
  geom_point(alpha=0.4, size=3.5, aes(color=change)) +
  scale_color_manual(values=c("blue", "grey","red"))+
  geom_vline(xintercept=c(-logFC_t,logFC_t),lty=4,col="black",linewidth=0.8) +
  geom_hline(yintercept = -log10(p_t),lty=4,col="black",linewidth=0.8) +
  theme_bw()
```


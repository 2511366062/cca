---
title: "Mye"
author: "lixiaokang"
date: "2025-04-22"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## 1. èšç±»åˆ†æ
```{r}
library(harmony)

obj_macr = subset(sce.all, celltype == "macrophage")
obj_macr = obj_macr %>% 
    NormalizeData() %>%  
    FindVariableFeatures() %>%  
    ScaleData(features = rownames(.)) %>%  
    RunPCA(pc.genes = VariableFeatures(.))  %>%
    RunHarmony("orig.ident") %>%
    FindNeighbors(dims = 1:15, reduction = "harmony") %>% 
    FindClusters(resolution = 0.7) %>% 
    RunUMAP(dims = 1:15,reduction = "harmony") #%>% 

#0 - 13ä¸ªç°‡

```


## æ³¨é‡Š
```{r}

markers <- FindAllMarkers(obj_macr, #only.pos = TRUE, åªè¿”å›æ­£
                               min.pct = 0.25, #è¿‡æ»¤æ¡ä»¶ï¼Œè‡³å°‘è¦åœ¨æŸä¸ªğŸˆ¶25%ç»†èƒè¡¨è¾¾
                               #logfc.threshold = 0.25#logFC>0.25
                               )
  
    test_markers = markers[markers$avg_log2FC > 0.4 & 
                             markers$pct.1 > 0.25  & 
                             markers$cluster %in% 11:15 &
                             markers$p_val_adj < 0.01,c("avg_log2FC","cluster", "gene")]
library(data.table)
fwrite(test_markers, "export/test_markers(11-15).csv")

writeLines(paste0(as.character(0:15),","))

obj_macr= zhushi(object = obj_macr,file = "import/zhushi/macr_zhushi.txt")



genes = c("CD163", "APOE", "FOLR2",
          "CCL3", "CXCL9", "HSPA1A",
          "S100A8","S100A9", "FCN1", "LYZ",
          "SPP1", "CTSD", "FN1",
          "S100A12", "CFP", "FCN1",
          	"CD207" ,"CD1A","FCER1A",
          "APOE","C1QA","C1QC",
          "MKI67","TOP2A","TYMS",
          	"CXCL5","IL6","IL1B",
          	"C3","ALOX5AP","FCGBP",
          "CXCL13",
          "CCL17", "CCL22", "LAMP3", "FSCN1", "TUBB2B",
          "CLEC9A", "XCR1", "DNASE1L3", "WDFY4", "BATF3",
          "LGALS7B", "KRT18", "SOX2", "WFDC2", "CLDN3",
          "MKI67", "TOP2A", "CDKN2C", "CENPF", "UBE2C",
          "ISG15", "IFI27", "OAS1", "MX1", "STAT1"
          
          )

# åˆ†ç°‡å›¾
p0 = clusterCornerAxes(object = obj_macr,
                  reduction = 'umap',
                  noSplit = T,#ä¸ç»„
                  clusterCol = 'seurat_clusters',
                  cellLabel = T,#è®¾ç½®äº†åˆ™åœ¨å›¾ä¸­æ ‡å‡ºæ¥
                  cellLabelSize = 10,#ç»†èƒåçš„å¤§å°
                  pSize = 0.1,
                  arrowType='open',#åˆ†å¼€çš„ç®­å¤´
                  show.legend = T, #åˆ é™¤å›¾ä¾‹
                  
                  ) + scale_color_manual(values = palette)






#æ³¨é‡Šå›¾
p1 = clusterCornerAxes(object = obj_macr,
                  reduction = 'umap',
                  noSplit = T,#ä¸ç»„
                  clusterCol = 'celltype',
                  cellLabel = T,#è®¾ç½®äº†åˆ™åœ¨å›¾ä¸­æ ‡å‡ºæ¥
                  cellLabelSize = 5,#ç»†èƒåçš„å¤§å°
                  pSize = 0.1,
                  arrowType='open',#åˆ†å¼€çš„ç®­å¤´
                  show.legend = T, #åˆ é™¤å›¾ä¾‹
                  
                  ) +
scale_color_manual(values = palette)
p1

p0 + p1

pdf(file = "plot/macrophage/UMAP_.pdf",width = 15,height = 10)
p0 + p1
dev.off





```

## ç”»å›¾ï¼šUMAPå¯¹æ¯” ç»†èƒæ•°é‡æ¡å½¢å›¾ æ¯”ä¾‹å›¾
```{r}
umap = yaqun_paint_umap(obj = obj_macr)
shuliangtu = yaqun_paint_tiaoxingtu(obj = obj_macr,"turned","normal")
bili = yaqun_paint_bili(obj = obj_macr)

pdf(file = "plot/macrophage/è½¬ç§»ç»„å’Œéè½¬ç§»ç»„çš„UMAP.pdf",width = 15,height = 10)
umap$umap_comp
dev.off

pdf(file = "plot/macrophage/6ä¸ªæ ·æœ¬çš„UMAP.pdf",width = 15,height = 10)
umap$umap_sample
dev.off


pdf(file = "plot/macrophage/æ‰€æœ‰ç»†èƒä¸ªæ•°ç»Ÿè®¡.pdf",width = 12,height = 9)
shuliangtu$all
dev.off

pdf(file = "plot/macrophage/è½¬ç§»ç»„ä¸ªæ•°ç»Ÿè®¡.pdf",width = 12,height = 9)
shuliangtu$yes
dev.off

pdf(file = "plot/macrophage/éè½¬ç§»ä¸ªæ•°ç»Ÿè®¡.pdf",width = 12,height = 9)
shuliangtu$no
dev.off

pdf(file = "plot/macrophage/turned_norturnedç»†èƒæ¯”ä¾‹æ¡å½¢å›¾.pdf",width = 12,height = 9)
bili$two
dev.off

pdf(file = "plot/macrophage/6æ ·æœ¬ç»†èƒæ¯”ä¾‹æ¡å½¢å›¾.pdf",width = 12,height = 9)
bili$all
dev.off


```
## markeråŸºå› æ°”æ³¡å›¾å’Œçƒ­å›¾
```{r}
list = heatmap_paopaotu(obj = obj_macr,file = "import/marker/T_markers.csv")


  
pdf(file = "plot/macrophage/markeråŸºå› æ°”æ³¡å›¾.pdf",width = 15,height = 10)
list$paopao
dev.off

pdf(file = "plot/macrophage/markeråŸºå› çƒ­å›¾.pdf",width = 15,height = 10)
list$heatmap
dev.off

```

## å·®å¼‚è¡¨è¾¾åˆ†æ
```{r}

#æ‰€æœ‰çš„
marco_diff = diff_we(object = obj_macr,
                   ident_1 = "turned",
                   ident_2 = "normal",
                   category = "category",
                  log2FC = 0.4)
 genes = rownames(marco_diff)[marco_diff$tag %in% c("up","down")]
 
 genesUp = get_upgene(object = marco_diff)
 genesdown = rownames(marco_diff)[marco_diff$tag %in% c("down")]
 
 
 do_genesUp = c(
  "MMP9",    # åŸºè´¨é™è§£
  "SPP1",    # è‚¿ç˜¤è¿ç§»
  "CCL2",    # å…ç–«æŠ‘åˆ¶å¾®ç¯å¢ƒ
  "TNF",     # NF-ÎºBç‚ç—‡é€šè·¯
  "LGMN",    # æº¶é…¶ä½“æ´»åŒ–
  "RUNX3",   # EMTè°ƒæ§
  "MMP14",   # ä¾µè¢­å¢å¼º
  "CXCL8",   # è¡€ç®¡ç”Ÿæˆ
  "PLAU",    # çº¤æº¶é…¶æ¿€æ´»
  "GZMB",
  "ITGA9"    # ç»†èƒé»é™„
)
 
 do_genesDown =  c(
  "CLU",       # æŠ‘åˆ¶åŸºè´¨é™è§£å’ŒEMTï¼ˆæ–‡çŒ®ï¼šNat Rev Cancer, 2009ï¼‰
  "SFN",       # é˜»æ»ç»†èƒå‘¨æœŸå’Œè½¬ç§»ï¼ˆæ–‡çŒ®ï¼šOncogene, 2016ï¼‰
  "ID1",       # æŠ‘åˆ¶EMTå’Œå¹²ç»†èƒç‰¹æ€§ï¼ˆæ–‡çŒ®ï¼šCell Stem Cell, 2019ï¼‰
  "ID3",       # é˜»æ–­TGF-Î²é€šè·¯é©±åŠ¨çš„è½¬ç§»ï¼ˆæ–‡çŒ®ï¼šCancer Res, 2018ï¼‰
  "CEBPD",     # æŠ‘åˆ¶è‚¿ç˜¤ä¾µè¢­å’Œè¡€ç®¡ç”Ÿæˆï¼ˆæ–‡çŒ®ï¼šJ Pathol, 2020ï¼‰
  "SERPINH1",  # è°ƒæ§èƒ¶åŸç¨³æ€æŠ‘åˆ¶è½¬ç§»ï¼ˆæ–‡çŒ®ï¼šMatrix Biol, 2021ï¼‰
  "CALML3",    # æŠ‘åˆ¶é’™ä¿¡å·ä»‹å¯¼çš„ç»†èƒè¿ç§»ï¼ˆæ–‡çŒ®ï¼šSci Rep, 2017ï¼‰
  "CLEC10A",   # å¢å¼ºæŠ—è‚¿ç˜¤å…ç–«åº”ç­”ï¼ˆæ–‡çŒ®ï¼šFront Immunol, 2020ï¼‰
  "S100A8",    # åŒåˆƒå‰‘ï¼ˆä½è¡¨è¾¾æ—¶ä¸§å¤±ç‚ç—‡æŠ‘åˆ¶åŠŸèƒ½ï¼‰ï¼ˆæ–‡çŒ®ï¼šNat Commun, 2018ï¼‰
  "FKBP5"      # æŠ‘åˆ¶HIF-1Î±é€šè·¯å’Œç¼ºæ°§é€‚åº”ï¼ˆæ–‡çŒ®ï¼šCancer Lett, 2021ï¼‰
)
 
 
 ls_hs = getMyHSplot(object = marco_diff,genes = c(do_genesDown,do_genesUp))
 
 pdf("plot/macrophage/ä¿ƒè½¬ç§»é‡ç‚¹åŸºå› çš„ç«å±±å›¾.pdf",width = 10,height = 8)
ls_hs$p1
dev.off



#umapå›¾å±•ç¤ºåŸºå› è¡¨è¾¾æƒ…å†µ
p = featureCornerAxes(object = obj_macr,reduction = 'umap',
                  groupFacet ="category",
                  relLength = 0.5,
                  relDist = 0.2,
                  axes = 'one',
                  features = do_genesUp,
                  minExp = 0,maxExp = 4,
                  pSize = 0.1,
                  low = "#edf8b1",
                  high = "#2c7fb8"
                  )

  pdf("plot/macrophage/ä¿ƒè½¬ç§»ä¸Šè°ƒåŸºå› è¡¨è¾¾æƒ…å†µ.pdf",width = 10,height = 20)
p
dev.off



p = featureCornerAxes(object = obj_macr,reduction = 'umap',
                  groupFacet ="category",
                  relLength = 0.5,
                  relDist = 0.2,
                  axes = 'one',
                  features = do_genesDown,
                  minExp = 0,maxExp = 4,
                  pSize = 0.1,
                  low = "#edf8b1",
                  high = "#2c7fb8"
                  )

pdf("plot/macrophage/ä¿ƒè½¬ç§»ä¸‹è°ƒåŸºå› è¡¨è¾¾æƒ…å†µ.pdf",width = 10,height = 20)
p
dev.off



#çƒ­å›¾å±•ç¤º
DoHeatmap(obj_macr, features = do_genesUp) + NoLegend()+
  scale_fill_gradientn(colors = c("#2fa1dd", "white", "#f87669"))
```


#å¯Œé›†åˆ†æ
```{r}
ls = do_GO_KEGG(object = marco_diff,filego = "plot/macrophage/trep_go.csv",filekegg = "plot/macrophage/trep_kegg.csv",tag = "up")
pdf("plot/macrophage/goåˆ†ææ°”æ³¡å›¾.pdf",width = 10,height = 15)
ls$go_p2
dev.off

pdf("plot/macrophage/keggåˆ†ææ°”æ³¡å›¾.pdf",width = 10,height = 15)
ls$kegg_p2
dev.off

```


## å°æç´å›¾
```{r}

 pdudu = gene_to_gene(obj = obj_macr,
            celltypes = "t_C1_KLRB1+",
            genes = "PKM",
            category = "category")
compare_OneGene(object = subset(obj_macr,celltype == "t_C1_KLRB1+"),
                     gene = "PKM",
                     category = "category",
                     cellname = "t_C1_KLRB1+")
p1 = compare_OneGene(object = subset(obj_macr,celltype == "Tprolif"),gene = "CTLA4",category = "category",cellname = "CTLA4")

p2 = compare_OneGene(object = subset(obj_macr,celltype == "Tprolif"),gene = "CCL20",category = "category",cellname = "CCL20")
p2

p3 = compare_OneGene(object = subset(obj_macr,celltype == "Tprolif"),gene = "CTSH",category = "category",cellname = "CTSH")
p3





pdf(file = "plot/macrophage/Tprolifä¸€äº›ä¿ƒè½¬ç§»ä¸Šè°ƒåŸºå› .pdf",width = 12,height = 7)
p1 + p2 + p3
dev.off



```


#GSEAå¯Œé›†åˆ†æ
```{r}
all_gene = rownames(marco_diff)
all_ENTREZID = bitr(all_gene, 
                      fromType = "SYMBOL", 
                      toType = "ENTREZID", 
                      OrgDb = org.Hs.eg.db)
marco_diff_log2FC = marco_diff[which(rownames(marco_diff) %in% all_ENTREZID$SYMBOL),]

logFC_dat = data.frame(SYMBOL = rownames(marco_diff_log2FC),log2FC = marco_diff_log2FC$avg_log2FC)

finally_dat = merge(logFC_dat,all_ENTREZID,by = "SYMBOL")
finally_vector = as.vector(finally_dat$log2FC)
names(finally_vector) = as.vector(finally_dat$ENTREZID)
finally_vector = sort(finally_vector,decreasing = T)

GSEA_KEGG <- gseKEGG(finally_vector, organism = 'hsa', pvalueCutoff = 0.05,pAdjustMethod = "BH")

#ä½¿ç”¨GOæ•°æ®åº“å¯Œé›†åˆ°äº†
GSEA_GO <- gseGO(
  geneList = finally_vector,
  OrgDb = org.Hs.eg.db,
  ont = "BP",  # Biological Process
  pvalueCutoff = 0.05
)

# ä½¿ç”¨KEGGæ•°æ®åº“é‡æ–°è¿è¡ŒgseKEGG,è¿™é‡Œæ²¡æœ‰å¯Œé›†åˆ°
GSEA_KEGG <- gseKEGG(
  geneList = finally_vector,
  organism = "hsa",
  pvalueCutoff = 0.08 #0.25
)


library(clusterProfiler)
library(org.Hs.eg.db)
#devtools::install_github("junjunlab/GseaVis")
library("GseaVis")

 p = dotplotGsea(data=GSEA_KEGG,topn=10,add.seg = T)
pdf(file = "plot/macrophage/macroç»†èƒçš„GSEAå¯Œé›†åˆ†æTOP10.pdf",width = 10,height = 10)
 p
dev.off


activated_pro_metastasis <- c(
  "NF-kappa B signaling pathway",                # ä¿ƒç‚ç—‡å’Œç»†èƒå­˜æ´»
  "TNF signaling pathway",                       # ç‚ç—‡å¾®ç¯å¢ƒæ”¯æŒè½¬ç§»
  "Human papillomavirus infection",              # HPVç™Œè›‹ç™½é©±åŠ¨è½¬ç§»
  "Chemokine signaling pathway",                # ä¿ƒè¿›è‚¿ç˜¤ç»†èƒè¿ç§»
  "IL-17 signaling pathway",                    # å¢å¼ºç‚ç—‡å’Œè¡€ç®¡ç”Ÿæˆ
  "Transcriptional misregulation in cancer",     # ç™ŒåŸºå› è½¬å½•æ¿€æ´»
  "TLR signaling pathway",                       # æ¿€æ´»å…ç–«é€ƒé€¸
  "Estrogen signaling pathway"                # æ¿€ç´ ä¿ƒè¿›è‚¿ç˜¤è¿›å±•
                          
)


inhibited_anti_metastasis <- c(
  "Apoptosis",                                   # å‡‹äº¡æŠ‘åˆ¶å¯¼è‡´ç»†èƒå­˜æ´»
  "Efferocytosis",                               # å‡‹äº¡æ¸…é™¤éšœç¢ä¿ƒè¿›ç‚ç—‡
  "RIG-I-like receptor signaling pathway"       # æŠ—ç—…æ¯’å…ç–«æŠ‘åˆ¶åå…è®¸è½¬ç§»
)

terms_up = GSEA_KEGG@result[GSEA_KEGG@result$Description %in% activated_pro_metastasis,]$ID
terms_down = GSEA_KEGG@result[GSEA_KEGG@result$Description %in% inhibited_anti_metastasis,]$ID



gseaNb(object=GSEA_KEGG,
geneSetID='hsa05134',
newGsea=T)











p = gseaNb(object=GSEA_KEGG,
geneSetID=terms_up,
subPlot=2,
termWidth=35,
curveCol = palette[1:9],
legend.position=c(0.8,0.8))


pdf(file = "plot/macrophage/Tç»†èƒçš„GSEAå¯Œé›†åˆ†æ:ä¸€äº›ä¿ƒè½¬ç§»çš„é€šè·¯.pdf",width = 15,height = 12)
 p
dev.off


p = gseaNb(object=GSEA_KEGG,
geneSetID=terms_down,
subPlot=2,
termWidth=35,
curveCol = palette[1:9],
legend.position=c(0.8,0.8))


pdf(file = "plot/macrophage/Tç»†èƒçš„GSEAå¯Œé›†åˆ†æ:ä¸€äº›ä¿ƒè½¬ç§»çš„é€šè·¯.pdf",width = 15,height = 12)
 p
dev.off
```






## å±•ç¤ºæ¯ä¸ªç»†èƒç¾¤çš„topåŸºå› 
```{r}

Mye_allmarkers <- FindAllMarkers(obj_macr, #only.pos = TRUE, åªè¿”å›æ­£
                               min.pct = 0.4, #è¿‡æ»¤æ¡ä»¶ï¼Œè‡³å°‘è¦åœ¨æŸä¸ªğŸˆ¶25%ç»†èƒè¡¨è¾¾
                               #logfc.threshold = 0.25#logFC>0.25
                               )
p = markerVolcano(markers = Mye_allmarkers,
              topn = 5,
              labelCol = palette)

pdf(file = "plot/macrophage/top5åŸºå› .pdf",width = 15,height = 10)
p
dev.off
```


## æ‹Ÿæ—¶åºåˆ†æ
æ„å»ºMonocle3æ‰€éœ€æ•°æ®
expression_matrixï¼šè¡Œæ˜¯geneï¼Œåˆ—æ˜¯cellçš„è¡¨è¾¾çŸ©é˜µ
cell_metadata:å¯¹åº”Seuratå¯¹è±¡çš„meta.dataä¿¡æ¯
gene_metadata:åŸºå› åç§°ä¿¡æ¯ï¼Œå¯ç”¨Gene symbol
```{r}
library(monocle3)
library(Seurat)
library(tidyverse)

expression_matrix=obj_macr@assays$RNA$data
cell_metadata=data.frame(obj_macr@meta.data)
gene_annotation=data.frame(expression_matrix[,1])
gene_annotation[,1]=row.names(gene_annotation)
colnames(gene_annotation)=c("gene_short_name")
##æ„å»ºMonocle3 cdså¯¹è±¡
cds = new_cell_data_set(expression_data = expression_matrix,
                        cell_metadata = cell_metadata,
                        gene_metadata = gene_annotation)

#é¢„å¤„ç†ï¼Œç›¸å½“äºSeuratæµç¨‹normalizeè¿‡ç¨‹
#countsæ•°æ®é€‰æ‹©norm_method=c("log")
#dataæ•°æ®é€‰æ‹©norm_method=c("none")
cds<-preprocess_cds(cds,num_dim=50,norm_method=c("none"))

#å»é™¤æ‰¹æ¬¡æ•ˆåº”,å¤šä¸ªæ ·æœ¬æ—¶å¯ä»¥é€šè¿‡æ­¤æ–¹å¼å»é™¤æ‰¹æ¬¡
cds<-align_cds(cds,alignment_group="orig.ident")

##é™ç»´ï¼Œé»˜è®¤æ˜¯"Umap"æ–¹å¼
cds<-reduce_dimension(cds,cores=5)

##èšç±»åˆ†ç¾¤ï¼Œåˆ†è¾¨ç‡è°ƒå°ï¼Œæ˜¯ä¸ºäº†è®©ç»†èƒæ˜¯ä¸€ç¾¤å¯ä»¥æ›´å¥½å±•ç¤º
cds<-cluster_cells(cds,resolution=0.0000001)

##æ‹Ÿæ—¶åº
cds<-learn_graph(cds)


##é€‰æ‹©ç‰¹å®šç»†èƒä½œä¸ºèµ·ç‚¹ï¼Œä»£ç æ¯”äº¤äº’å¼é¡µé¢æ–¹ä¾¿è®¸å¤šï¼Œä¸”ä¸ä¼šå‡ºç°é€‰ä¸­è‡ªå·±ä¸æƒ³è¦çš„ç»†èƒ
##è¿™é‡Œæˆ‘ä»¬å‡å®šä»¥Bç»†èƒä¸ºèµ·ç‚¹
myselect<-function(cds,select.classify,my_select){
cell_ids<-which(colData(cds)[,select.classify]==my_select)
closest_vertex<-
cds@principal_graph_aux[["UMAP"]]$pr_graph_cell_proj_closest_vertex
closest_vertex<-as.matrix(closest_vertex[colnames(cds),])
root_pr_nodes<-
igraph::V(principal_graph(cds)[["UMAP"]])$name[as.numeric(names
(which.max(table(closest_vertex[cell_ids,]))))]
root_pr_nodes}

cds<-order_cells(cds,root_pr_nodes=myselect(cds,select.classify='celltype',my_select="t_Tcm_LINC02446+"))




##ä½¿ç”¨Seuratçš„UMAPä¿¡æ¯ï¼Œè¿™æ ·å¯ä»¥ä¸Seuratå¯¹è±¡çš„ç»†èƒåˆ†å¸ƒä¿æŒä¸€è‡´
#cds.embed<-cds@int_colData$reducedDims$UMAP
#int.embed<-Embeddings(obj_mye,reduction="umap")
#int.embed<-int.embed[rownames(cds.embed),]
#cds@int_colData$reducedDims$UMAP<-int.embed

# å®‰è£… ggsci åŒ…ï¼ˆå¦‚æœæœªå®‰è£…ï¼‰
#install.packages("ggsci")

# åŠ è½½åŒ…
library(ggsci)
##ä¸åŒç»†èƒç±»å‹æ‹Ÿæ—¶åºæ•°å€¼
##æ‹Ÿæ—¶åºå€¼è¶Šé«˜è¡¨ç¤ºç»†èƒåˆ†åŒ–ç¨‹åº¦è¶Šé«˜ï¼Œè¿™é‡Œä»…ä¸ºæ¼”ç¤ºï¼Œå¹¶éçœŸå®åˆ†åŒ–æƒ…å†µ
p = plot_cells(cds,color_cells_by="pseudotime",
  show_trajectory_graph=T)+plot_cells(cds,
  color_cells_by="celltype",
  label_cell_groups=FALSE,
  label_leaves=FALSE,
  label_branch_points=FALSE,
  graph_label_size=1)+scale_color_manual(values=pal_jco("default",alpha=0.6)(13))

pdf(file = "plot/macrophage//æ‹Ÿæ—¶åºåˆ†æ.pdf",width = 10,height = 7)
p
dev.off

genes<-c('CD19','t',"SPP1")
genes_cds<-cds[rowData(cds)$gene_short_name%in%genes,]
p = plot_genes_in_pseudotime(genes_cds,color_cells_by="celltype",min_expr=0.5,cell_size=1.5)+scale_color_manual(values=pal_jco("default",alpha=0.6)(13))

pdf(file = "plot/Mye/Monocle3å·®å¼‚åˆ†ææ.pdf",width = 15,height = 10)
p
dev.off
```






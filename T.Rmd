---
title: "Mye"
author: "lixiaokang"
date: "2025-04-22"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## 1. èšç±»åˆ†æ
```{r}
library(harmony)

obj_t = subset(sce.all, celltype == "T cells")
obj_t = obj_t %>% 
    NormalizeData() %>%  
    FindVariableFeatures() %>%  
    ScaleData(features = rownames(.)) %>%  
    RunPCA(pc.genes = VariableFeatures(.))  %>%
    RunHarmony("orig.ident") %>%
    FindNeighbors(dims = 1:15, reduction = "harmony") %>% 
    FindClusters(resolution = 0.7) %>% 
    RunUMAP(dims = 1:15,reduction = "harmony") #%>% 

#0 - 13ä¸ªç°‡

```


## æ³¨é‡Š
```{r}

markers <- FindAllMarkers(obj_t, #only.pos = TRUE, åªè¿”å›æ­£
                               min.pct = 0.25, #è¿‡æ»¤æ¡ä»¶ï¼Œè‡³å°‘è¦åœ¨æŸä¸ªğŸˆ¶25%ç»†èƒè¡¨è¾¾
                               #logfc.threshold = 0.25#logFC>0.25
                               )
  
    test_markers = markers[markers$avg_log2FC > 0.4 & 
                             markers$pct.1 > 0.25  & 
                             markers$cluster %in% c(11,12)&
                             markers$p_val_adj < 0.01,c("avg_log2FC","cluster", "p_val_adj", "gene")]
library(data.table)
fwrite(test_markers, "export/test_markers_testT(11-12).csv")

writeLines(paste0(as.character(0:12),","))

obj_t= zhushi(object = obj_t,file = "import/zhushi/T_zhushi.txt")





# åˆ†ç°‡å›¾
p0 = clusterCornerAxes(object = obj_t,
                  reduction = 'umap',
                  noSplit = T,#ä¸ç»„
                  clusterCol = 'seurat_clusters',
                  cellLabel = T,#è®¾ç½®äº†åˆ™åœ¨å›¾ä¸­æ ‡å‡ºæ¥
                  cellLabelSize = 10,#ç»†èƒåçš„å¤§å°
                  pSize = 0.1,
                  arrowType='open',#åˆ†å¼€çš„ç®­å¤´
                  show.legend = T, #åˆ é™¤å›¾ä¾‹
                  
                  ) + scale_color_manual(values = palette)






#æ³¨é‡Šå›¾
p1 = clusterCornerAxes(object = obj_t,
                  reduction = 'umap',
                  noSplit = T,#ä¸ç»„
                  clusterCol = 'celltype',
                  cellLabel = T,#è®¾ç½®äº†åˆ™åœ¨å›¾ä¸­æ ‡å‡ºæ¥
                  cellLabelSize = 5,#ç»†èƒåçš„å¤§å°
                  pSize = 0.1,
                  arrowType='open',#åˆ†å¼€çš„ç®­å¤´
                  show.legend = T, #åˆ é™¤å›¾ä¾‹
                  
                  ) +
scale_color_manual(values = palette)
p1

p0 + p1

pdf(file = "plot/t/UMAP_.pdf",width = 15,height = 10)
p0 + p1
dev.off





```

## ç”»å›¾ï¼šUMAPå¯¹æ¯” ç»†èƒæ•°é‡æ¡å½¢å›¾ æ¯”ä¾‹å›¾
```{r}
umap = yaqun_paint_umap(obj = obj_t)




```
## markeråŸºå› æ°”æ³¡å›¾å’Œçƒ­å›¾
```{r}
list = heatmap_paopaotu(obj = obj_t,file = "import/marker/T_markers.csv")

pdf(file = "plot/t/markeråŸºå› æ°”æ³¡å›¾.pdf",width = 15,height = 10)
list$paopao
dev.off

pdf(file = "plot/t/markeråŸºå› çƒ­å›¾.pdf",width = 15,height = 10)
list$heatmap
dev.off

```

## å·®å¼‚è¡¨è¾¾åˆ†æ
```{r}

#æ‰€æœ‰çš„
t_diff = diff_we(object = obj_t,
                   ident_1 = "turned",
                   ident_2 = "normal",
                   category = "category",
                  log2FC = 0.4)
 genes = rownames(t_diff)[t_diff$tag %in% c("up","down")]
 
 genesUp = get_upgene(object = t_diff)
 genesdown = rownames(t_diff)[t_diff$tag %in% c("down")]
 
 
 do_genesUp = c(
  "CTLA4",    # å…ç–«æ£€æŸ¥ç‚¹åˆ†å­ï¼ŒæŠ‘åˆ¶Tç»†èƒåŠŸèƒ½ï¼Œä¿ƒè¿›å…ç–«é€ƒé€¸
  "CXCR6",    # è¶‹åŒ–å› å­å—ä½“ï¼Œé©±åŠ¨Tç»†èƒå‘è½¬ç§»ç¶è¿ç§»å¹¶é‡å¡‘å¾®ç¯å¢ƒ
  "NFKB1",    # è°ƒæ§ç‚ç—‡å’Œä¾µè¢­ä¿¡å·é€šè·¯ï¼Œä¿ƒè¿›è‚¿ç˜¤è½¬ç§»å‰ç”Ÿæ€ä½å½¢æˆ
  "CCL20",    # æ‹›å‹Ÿå…ç–«æŠ‘åˆ¶ç»†èƒï¼ˆå¦‚Tregsã€MDSCsï¼‰ï¼Œå»ºç«‹å…ç–«è±å…å¾®ç¯å¢ƒ
  "CTSH",     # ç»„ç»‡è›‹ç™½é…¶Hï¼Œé™è§£ç»†èƒå¤–åŸºè´¨ï¼ˆECMï¼‰ï¼Œå¢å¼ºè‚¿ç˜¤ç»†èƒä¾µè¢­èƒ½åŠ›
  "VMP1",     # è‡ªå™¬ç›¸å…³è›‹ç™½ï¼Œæ”¯æŒè½¬ç§»è¿‡ç¨‹ä¸­è‚¿ç˜¤ç»†èƒçš„ä»£è°¢é€‚åº”å’Œå­˜æ´»
  "RUNX1",    # è½¬å½•å› å­ï¼Œè°ƒæ§EMTï¼ˆä¸Šçš®-é—´è´¨è½¬åŒ–ï¼‰å’Œè½¬ç§»ç›¸å…³åŸºå› è¡¨è¾¾
  "FURIN" ,    # è›‹ç™½é…¶ï¼Œæ¿€æ´»ä¿ƒè½¬ç§»åˆ†å­ï¼ˆå¦‚MMPsã€TGF-Î²ï¼‰ï¼Œé©±åŠ¨ä¾µè¢­æ€§
  "GZMB",
  "SPP1"
)
 
 do_genesDown =  c(
  "CD3E",    # Tç»†èƒå—ä½“æ ¸å¿ƒç»„åˆ†ï¼Œä¸‹è°ƒå¯¼è‡´Tç»†èƒåŠŸèƒ½ä¸§å¤±
  "IL7R",    # Tç»†èƒå­˜æ´»ä¿¡å·å—ä½“ï¼Œä¸‹è°ƒå‰Šå¼±æŠ—è‚¿ç˜¤å…ç–«
  "CXCR3",   # è¶‹åŒ–å› å­å—ä½“ï¼Œä¸‹è°ƒå‡å°‘Tç»†èƒè‚¿ç˜¤æµ¸æ¶¦
  "CD9",     # å››è·¨è†œè›‹ç™½ï¼ŒæŠ‘åˆ¶è‚¿ç˜¤ä¾µè¢­è½¬ç§»
  "CD63",    # æº¶é…¶ä½“è†œè›‹ç™½ï¼Œè°ƒæ§ç»†èƒè¿ç§»ï¼Œä¸‹è°ƒä¿ƒè¿›ä¾µè¢­
  "MGP",     # åŸºè´¨Glaè›‹ç™½ï¼ŒæŠ‘åˆ¶è¡€ç®¡å¼‚å¸¸é‡å¡‘
  "APOE"     # è°ƒæ§è„‚ä»£è°¢ï¼Œå½±å“è‚¿ç˜¤å¾®ç¯å¢ƒç¨³æ€
)
 
 
 ls_hs = getMyHSplot(object = t_diff,genes = c(do_genesDown,do_genesUp))
 
 pdf("plot/t/ä¿ƒè½¬ç§»é‡ç‚¹åŸºå› çš„ç«å±±å›¾.pdf",width = 10,height = 8)
ls_hs$p1
dev.off



#umapå›¾å±•ç¤ºåŸºå› è¡¨è¾¾æƒ…å†µ
p = featureCornerAxes(object = obj_t,reduction = 'umap',
                  groupFacet ="category",
                  relLength = 0.5,
                  relDist = 0.2,
                  axes = 'one',
                  features = do_genesUp,
                  minExp = 0,maxExp = 4,
                  pSize = 0.1,
                  low = "#edf8b1",
                  high = "#2c7fb8"
                  )

  pdf("plot/t/ä¿ƒè½¬ç§»ä¸Šè°ƒåŸºå› è¡¨è¾¾æƒ…å†µ.pdf",width = 10,height = 20)
p
dev.off



p = featureCornerAxes(object = obj_t,reduction = 'umap',
                  groupFacet ="category",
                  relLength = 0.5,
                  relDist = 0.2,
                  axes = 'one',
                  features = do_genesDown,
                  minExp = 0,maxExp = 4,
                  pSize = 0.1,
                  low = "#edf8b1",
                  high = "#2c7fb8"
                  )

pdf("plot/t/ä¿ƒè½¬ç§»ä¸‹è°ƒåŸºå› è¡¨è¾¾æƒ…å†µ.pdf",width = 10,height = 20)
p
dev.off



#çƒ­å›¾å±•ç¤º
DoHeatmap(obj_t, features = do_genesUp) + NoLegend()+
  scale_fill_gradientn(colors = c("#2fa1dd", "white", "#f87669"))
```


#å¯Œé›†åˆ†æ
```{r}
ls = do_GO_KEGG(object = t_diff,filego = "plot/t/trep_go.csv",filekegg = "plot/t/trep_kegg.csv",tag = "up")
pdf("plot/t/goåˆ†ææ°”æ³¡å›¾.pdf",width = 10,height = 15)
ls$go_p2
dev.off

pdf("plot/t/keggåˆ†ææ°”æ³¡å›¾.pdf",width = 10,height = 15)
ls$kegg_p2
dev.off

```


## test
```{r}

SEMA4C = compare_OneGene(object = subset(obj_t,celltype == "Treg"),
                     gene = "SEMA4D",
                     category = "category",
                     cellname = "SEMA4D")
  pdf(paste0("plot/temp/SEMA4D", ".pdf"),width = 8,height = 7)
  p = SEMA4C
  print(p)
  dev.off()
  
  
  
SEMA4C = compare_OneGene(object = obj_t,
                     gene = "SEMA4D",
                     category = "category",
                     cellname = "SEMA4D")
  pdf(paste0("plot/temp/SEMA4D", ".pdf"),width = 8,height = 7)
  p = SEMA4C
  print(p)
  dev.off()
```



## å°æç´å›¾
```{r}



tlist = two_group_genes_viloin_all(obj = obj_cafs,color = palette,genes = do_genesUp)

tlist_down = two_group_genes_viloin_all(obj = obj_cafs,color = palette,genes = do_genesDown)

for (i in 1 : length(tlist)) {
  cellname = names(tlist)[i]
  pdf(paste0("plot/CAFs/ä¸Šè°ƒåŸºå› åœ¨äºšç¾¤ä¸­çš„å¯¹æ¯”/p", i, ".pdf"),width = 26,height = 7)
  p = tlist[[i]]
  print(p)
  dev.off()
  
}

for (i in 1 : length(tlist_down)) {
  cellname = names(tlist_down)[i]
  pdf(paste0("plot/CAFs/ä¸‹è°ƒåŸºå› åœ¨äºšç¾¤ä¸­çš„å¯¹æ¯”/p", i, ".pdf"),width = 23,height = 7)
  p = tlist_down[[i]]
  print(p)
  dev.off()
  
}





SEMA4C = compare_OneGene(object = subset(obj_cafs,celltype == "Treg"),
                     gene = "SEMA4D",
                     category = "category",
                     cellname = "SEMA4D")








 pdudu = gene_to_gene(obj = obj_cafs,
            celltypes = "myCAFs",
            genes = "THBS",
            category = "category")
SEMA4C = compare_OneGene(object = subset(obj_cafs,celltype == "myCAFs"),
                     gene = "SEMA4C",
                     category = "category",
                     cellname = "SEMA4C")


SEMA4C = compare_OneGene(object = subset(obj_cafs,celltype == "mCAFs"),
                     gene = "SEMA4D",
                     category = "category",
                     cellname = "SEMA4D")

genes = c("SEMA4D","SEMA4C","SEMA4A","THBS1","THBS2")
cellnames = c("iCAFs","CAFs_CXCL13+","eCAFs","imCAFs","invCAFs")


cellname = "invCAFs"
gene = "THBS2"
cellobj =  subset(obj_cafs,celltype == cellname)

    p = compare_OneGene(object = cellobj,
                     gene = gene,
                     category = "category",
                     cellname = gene)
    
    pname = paste0("plot/newfig/ç®±çº¿å›¾_",cellname,"_",gene,".pdf")
    
    pdf(file = pname,width = 8,height = 6)
      print(p)
    dev.off()

    
cellnames = c("mCAFs","myCAFs","pCAFs")
genes = c("SEMA4D","SEMA4C","SEMA4A","THBS1","THBS2")

cellname = "myCAFs"
markercolor = c("#edf8b1","#2c7fb8")
temp = subset(obj_cafs,celltype == cellname)



p = markerDot(temp,genes,colors = markercolor,id = "category")
p



myggsave(file = "plot/newfig/fig_5_Då›¾.pdf", plot = p, dpi = 600, width = 15,height = 5)


gene


plist = list()




for(cellname in cellnames){
  
  cellobj =  subset(obj_cafs,celltype == cellname)
  
  for(gene in genes){
    
    p = compare_OneGene(object = cellobj,
                     gene = gene,
                     category = "category",
                     cellname = gene)
    
    pname = paste0("plot/newfig/ç®±çº¿å›¾_",cellname,"_",gene,".pdf")
    
    pdf(file = pname,width = 8,height = 6)
      print(p)
    dev.off()
    
  }
  
}






p1 = compare_OneGene(object = subset(obj_t,celltype == "Tprolif"),gene = "CTLA4",category = "category",cellname = "CTLA4")

p2 = compare_OneGene(object = subset(obj_t,celltype == "Tprolif"),gene = "CCL20",category = "category",cellname = "CCL20")
p2

p3 = compare_OneGene(object = subset(obj_t,celltype == "Tprolif"),gene = "CTSH",category = "category",cellname = "CTSH")
p3





pdf(file = "plot/t/Tprolifä¸€äº›ä¿ƒè½¬ç§»ä¸Šè°ƒåŸºå› .pdf",width = 12,height = 7)
p1 + p2 + p3
dev.off



```


#GSEAå¯Œé›†åˆ†æ
```{r}
all_gene = rownames(t_diff)
all_ENTREZID = bitr(all_gene, 
                      fromType = "SYMBOL", 
                      toType = "ENTREZID", 
                      OrgDb = org.Hs.eg.db)
t_diff_log2FC = t_diff[which(rownames(t_diff) %in% all_ENTREZID$SYMBOL),]

logFC_dat = data.frame(SYMBOL = rownames(t_diff_log2FC),log2FC = t_diff_log2FC$avg_log2FC)

finally_dat = merge(logFC_dat,all_ENTREZID,by = "SYMBOL")
finally_vector = as.vector(finally_dat$log2FC)
names(finally_vector) = as.vector(finally_dat$ENTREZID)
finally_vector = sort(finally_vector,decreasing = T)

GSEA_KEGG <- gseKEGG(finally_vector, organism = 'hsa', pvalueCutoff = 0.05,pAdjustMethod = "BH")

#ä½¿ç”¨GOæ•°æ®åº“å¯Œé›†åˆ°äº†
GSEA_GO <- gseGO(
  geneList = finally_vector,
  OrgDb = org.Hs.eg.db,
  ont = "BP",  # Biological Process
  pvalueCutoff = 0.05
)

# ä½¿ç”¨KEGGæ•°æ®åº“é‡æ–°è¿è¡ŒgseKEGG,è¿™é‡Œæ²¡æœ‰å¯Œé›†åˆ°
GSEA_KEGG <- gseKEGG(
  geneList = finally_vector,
  organism = "hsa",
  pvalueCutoff = 0.08 #0.25
)


library(clusterProfiler)
library(org.Hs.eg.db)
#devtools::install_github("junjunlab/GseaVis")
library("GseaVis")

 p = dotplotGsea(data=GSEA_KEGG,topn=10,add.seg = T)
pdf(file = "plot/t/Tç»†èƒçš„GSEAå¯Œé›†åˆ†æ.pdf",width = 10,height = 10)
 p
dev.off


key_metastasis_pathways <- c(
  "MAPK signaling pathway",              # è°ƒæ§ç»†èƒè¿ç§»ã€ä¾µè¢­å’ŒEMT
  "NF-kappa B signaling pathway",        # é©±åŠ¨ç‚ç—‡ååº”å’ŒæŠ—å‡‹äº¡ï¼Œä¿ƒè¿›è½¬ç§»å¾®ç¯å¢ƒ
  "HIF-1 signaling pathway",             # ç¼ºæ°§é€‚åº”ï¼Œå¢å¼ºè¡€ç®¡ç”Ÿæˆå’Œç»†èƒä¾µè¢­
  "TNF signaling pathway",               # æ¿€æ´»ä¿ƒç‚å› å­ï¼Œä¿ƒè¿›åŸºè´¨é‡å¡‘å’Œå…ç–«é€ƒé€¸
  "IL-17 signaling pathway",             # ä»‹å¯¼æ…¢æ€§ç‚ç—‡ï¼ŒåŠ é€Ÿè‚¿ç˜¤ç»†èƒæ‰©æ•£
  "Transcriptional misregulation in cancer", # è‡´ç™Œè½¬å½•å› å­ï¼ˆå¦‚MYCã€STAT3ï¼‰é©±åŠ¨è½¬ç§»åŸºå› è¡¨è¾¾
  
  "Viral carcinogenesis"                 # ç—…æ¯’è›‹ç™½ï¼ˆå¦‚HPV E6/E7ï¼‰ç ´åæŠ‘ç™ŒåŸºå› ï¼Œé—´æ¥ä¿ƒè¿›è½¬ç§»
)

terms = GSEA_KEGG@result[GSEA_KEGG@result$Description %in% key_metastasis_pathways,]$ID

gseaNb(object=GSEA_KEGG,
geneSetID='hsa05134',
newGsea=T)











p = gseaNb(object=GSEA_KEGG,
geneSetID=terms,
subPlot=2,
termWidth=35,
curveCol = palette[1:9],
legend.position=c(0.8,0.8))


pdf(file = "plot/t/Tç»†èƒçš„GSEAå¯Œé›†åˆ†æ:ä¸€äº›ä¿ƒè½¬ç§»çš„é€šè·¯.pdf",width = 15,height = 12)
 p
dev.off
```






## å±•ç¤ºæ¯ä¸ªç»†èƒç¾¤çš„topåŸºå› 
```{r}

Mye_allmarkers <- FindAllMarkers(obj_t, #only.pos = TRUE, åªè¿”å›æ­£
                               min.pct = 0.4, #è¿‡æ»¤æ¡ä»¶ï¼Œè‡³å°‘è¦åœ¨æŸä¸ªğŸˆ¶25%ç»†èƒè¡¨è¾¾
                               #logfc.threshold = 0.25#logFC>0.25
                               )
p = markerVolcano(markers = Mye_allmarkers,
              topn = 5,
              labelCol = palette)

pdf(file = "plot/t/top5åŸºå› .pdf",width = 15,height = 10)
p
dev.off
```


## æ‹Ÿæ—¶åºåˆ†æ
æ„å»ºMonocle3æ‰€éœ€æ•°æ®
expression_matrixï¼šè¡Œæ˜¯geneï¼Œåˆ—æ˜¯cellçš„è¡¨è¾¾çŸ©é˜µ
cell_metadata:å¯¹åº”Seuratå¯¹è±¡çš„meta.dataä¿¡æ¯
gene_metadata:åŸºå› åç§°ä¿¡æ¯ï¼Œå¯ç”¨Gene symbol
```{r}
library(monocle3)
library(Seurat)
library(tidyverse)

expression_matrix=obj_t@assays$RNA$data
cell_metadata=data.frame(obj_t@meta.data)
gene_annotation=data.frame(expression_matrix[,1])
gene_annotation[,1]=row.names(gene_annotation)
colnames(gene_annotation)=c("gene_short_name")
##æ„å»ºMonocle3 cdså¯¹è±¡
cds = new_cell_data_set(expression_data = expression_matrix,
                        cell_metadata = cell_metadata,
                        gene_metadata = gene_annotation)

#é¢„å¤„ç†ï¼Œç›¸å½“äºSeuratæµç¨‹normalizeè¿‡ç¨‹
#countsæ•°æ®é€‰æ‹©norm_method=c("log")
#dataæ•°æ®é€‰æ‹©norm_method=c("none")
cds<-preprocess_cds(cds,num_dim=50,norm_method=c("none"))

#å»é™¤æ‰¹æ¬¡æ•ˆåº”,å¤šä¸ªæ ·æœ¬æ—¶å¯ä»¥é€šè¿‡æ­¤æ–¹å¼å»é™¤æ‰¹æ¬¡
cds<-align_cds(cds,alignment_group="orig.ident")

##é™ç»´ï¼Œé»˜è®¤æ˜¯"Umap"æ–¹å¼
cds<-reduce_dimension(cds,cores=5)

##èšç±»åˆ†ç¾¤ï¼Œåˆ†è¾¨ç‡è°ƒå°ï¼Œæ˜¯ä¸ºäº†è®©ç»†èƒæ˜¯ä¸€ç¾¤å¯ä»¥æ›´å¥½å±•ç¤º
cds<-cluster_cells(cds,resolution=0.0000001)

##æ‹Ÿæ—¶åº
cds<-learn_graph(cds)


##é€‰æ‹©ç‰¹å®šç»†èƒä½œä¸ºèµ·ç‚¹ï¼Œä»£ç æ¯”äº¤äº’å¼é¡µé¢æ–¹ä¾¿è®¸å¤šï¼Œä¸”ä¸ä¼šå‡ºç°é€‰ä¸­è‡ªå·±ä¸æƒ³è¦çš„ç»†èƒ
##è¿™é‡Œæˆ‘ä»¬å‡å®šä»¥Bç»†èƒä¸ºèµ·ç‚¹
myselect<-function(cds,select.classify,my_select){
cell_ids<-which(colData(cds)[,select.classify]==my_select)
closest_vertex<-
cds@principal_graph_aux[["UMAP"]]$pr_graph_cell_proj_closest_vertex
closest_vertex<-as.matrix(closest_vertex[colnames(cds),])
root_pr_nodes<-
igraph::V(principal_graph(cds)[["UMAP"]])$name[as.numeric(names
(which.max(table(closest_vertex[cell_ids,]))))]
root_pr_nodes}

cds<-order_cells(cds,root_pr_nodes=myselect(cds,select.classify='celltype',my_select="t_Tcm_LINC02446+"))




##ä½¿ç”¨Seuratçš„UMAPä¿¡æ¯ï¼Œè¿™æ ·å¯ä»¥ä¸Seuratå¯¹è±¡çš„ç»†èƒåˆ†å¸ƒä¿æŒä¸€è‡´
#cds.embed<-cds@int_colData$reducedDims$UMAP
#int.embed<-Embeddings(obj_mye,reduction="umap")
#int.embed<-int.embed[rownames(cds.embed),]
#cds@int_colData$reducedDims$UMAP<-int.embed

# å®‰è£… ggsci åŒ…ï¼ˆå¦‚æœæœªå®‰è£…ï¼‰
#install.packages("ggsci")

# åŠ è½½åŒ…
library(ggsci)
##ä¸åŒç»†èƒç±»å‹æ‹Ÿæ—¶åºæ•°å€¼
##æ‹Ÿæ—¶åºå€¼è¶Šé«˜è¡¨ç¤ºç»†èƒåˆ†åŒ–ç¨‹åº¦è¶Šé«˜ï¼Œè¿™é‡Œä»…ä¸ºæ¼”ç¤ºï¼Œå¹¶éçœŸå®åˆ†åŒ–æƒ…å†µ
p = plot_cells(cds,color_cells_by="pseudotime",
  show_trajectory_graph=T)+plot_cells(cds,
  color_cells_by="celltype",
  label_cell_groups=FALSE,
  label_leaves=FALSE,
  label_branch_points=FALSE,
  graph_label_size=1)+scale_color_manual(values=pal_jco("default",alpha=0.6)(13))

pdf(file = "plot/t//æ‹Ÿæ—¶åºåˆ†æ.pdf",width = 10,height = 7)
p
dev.off

genes<-c('CD19','t',"SPP1")
genes_cds<-cds[rowData(cds)$gene_short_name%in%genes,]
p = plot_genes_in_pseudotime(genes_cds,color_cells_by="celltype",min_expr=0.5,cell_size=1.5)+scale_color_manual(values=pal_jco("default",alpha=0.6)(13))

pdf(file = "plot/Mye/Monocle3å·®å¼‚åˆ†ææ.pdf",width = 15,height = 10)
p
dev.off
```

```{r}
Sys.getenv("R_HOME")
```



```{r}
library(Seurat)
load(file = "Rdata/dudu.Rdata")


mydata =read.csv("seruat/mat.csv")
meta <- read.table("seruat/metadata.tsv",sep="\t",header=T,row.names=1)
umap<- read.table("seruat/position_X_umap.tsv",sep="\t",header=T,row.names=1)

rownames(mydata)=mydata[,1]
mydata=mydata[,-1]
mat <- Matrix(t (mydata), sparse = TRUE)
exp=t(mydata)


obj <- CreateSeuratObject(exp, project ='cancer', assay = 'RNA', meta.data = meta)

obj <- SetAssayData(
    object = obj,
    slot   = "data",
    new.data = GetAssayData(obj, assay = "RNA", slot = "counts"),
    assay  = "RNA"
 )

```
```{r}

obj$category = obj$group
do_genesUp = c(       
    "SPP1",   # Osteopontin
    'GZMB',
    "GPNMB",  # Osteoactivin
    "ALCAM",  # CD166
    "IL1B",   # Interleukin-1Î²
    "FN1",    # Fibronectin
    "CCL3",   # MIP-1Î±
    "ADGRE5", # CD97
    "TREM2",
    "MSR1"   # Scavenger receptor
    )

do_genesDown = c(
  "RUNX3",   # è‚¿ç˜¤æŠ‘åˆ¶ï¼›ç¼ºå¤±/ä¸‹è°ƒ â†’ ä¾µè¢­/è½¬ç§»â†‘
    "SYK",     # æŠ‘åˆ¶è¿ç§»/EMTï¼›ä¸‹è°ƒ â†’ è½¬ç§»â†‘ï¼ˆä¹³è…ºç­‰ï¼‰
    "ARRDC3",  # è½¬ç§»æŠ‘åˆ¶å› å­ï¼›ä¸‹è°ƒ â†’ è¿ç§»/ä¾µè¢­â†‘
    "EPB41L3", # DAL-1ï¼Œç»†èƒéª¨æ¶/é»é™„ç›¸å…³æŠ‘ç™Œï¼›ä¸‹è°ƒ â†’ è½¬ç§»â†‘
    "DACH1",   # è½¬å½•æŠ‘åˆ¶å› å­ï¼›ä¸‹è°ƒ â†’ EMT/è½¬ç§»â†‘
    "PHLPP1",  # å»ç£·é…¸åŒ–AKTç­‰ï¼›ä¸‹è°ƒ â†’ AKTæ´»åŒ–/è½¬ç§»â†‘
    "RBM47",   # è½¬å½•åæŠ‘ç™Œï¼›ä¸‹è°ƒ â†’ è½¬ç§»â†‘
    "CPEB2",   # æŠ‘åˆ¶HIF-1Î±/EMTï¼›ä¸‹è°ƒ â†’ ä¾µè¢­/è½¬ç§»â†‘
    "G0S2",    # è„‚ä»£è°¢/å‡‹äº¡è°ƒæ§æŠ‘ç™Œï¼›ä¸‹è°ƒ â†’ è¿ç§»â†‘
    "THBS1",   # æŠ—è¡€ç®¡ç”Ÿæˆ/å¾®ç¯å¢ƒçº¦æŸï¼›ä¸‹è°ƒ â†’ è½¬ç§»ç”Ÿæ€ä½å½¢æˆâ†‘
    "ABCA1",   # èƒ†å›ºé†‡å¤–æ’/è†œç­ä¿¡å·æŠ‘åˆ¶ï¼›ä¸‹è°ƒ â†’ è¿ç§»ä¿¡å·â†‘
    "EMILIN2", # ECMæŠ‘ç™Œ/æŠ—è¡€ç®¡ç”Ÿæˆï¼›ä¸‹è°ƒ â†’ ä¾µè¢­/è¡€ç®¡ç”Ÿæˆâ†‘
    "CSTA"     # èƒ±å¤©è›‹ç™½é…¶æŠ‘åˆ¶ï¼›ä¸‹è°ƒ â†’ è›‹ç™½é…¶æ´»æ€§â†‘/ä¾µè¢­â†‘
)

colorsForDataType = paletteer_d("LaCroixColoR::Berry")
umapColor <- colorRampPalette(colorsForDataType)(length(unique(obj$celltype)))


plist = timeAllPlot(obj = subset(obj,category == "BC"),do_genesUp = do_genesUp,do_genesDown = do_genesDown,startGene = "C7_Macro_InflamMono" )
outTimeAllPlot(plist = plist,do_genesUp = do_genesUp,do_genesDown = do_genesDown,mydirname = "Macro/BC")

plist = timeAllPlot(obj = subset(obj,category == "KC"),do_genesUp = do_genesUp,do_genesDown = do_genesDown,startGene = "C7_Macro_InflamMono" )
outTimeAllPlot(plist = plist,do_genesUp = do_genesUp,do_genesDown = do_genesDown,mydirname = "Macro/KC")

plist = timeAllPlot(obj = subset(obj,category == "CC"),do_genesUp = do_genesUp,do_genesDown = do_genesDown,startGene = "C7_Macro_InflamMono" )
outTimeAllPlot(plist = plist,do_genesUp = do_genesUp,do_genesDown = do_genesDown,mydirname = "Macro/CC")


plist = timeAllPlot(obj = subset(obj,category == "LC"),do_genesUp = do_genesUp,do_genesDown = do_genesDown,startGene = "C7_Macro_InflamMono" )
outTimeAllPlot(plist = plist,do_genesUp = do_genesUp,do_genesDown = do_genesDown,mydirname = "Macro/LC")

plist = timeAllPlot(obj = subset(obj,category == "ctrl"),do_genesUp = do_genesUp,do_genesDown = do_genesDown,startGene = "C7_Macro_InflamMono" )
outTimeAllPlot(plist = plist,do_genesUp = do_genesUp,do_genesDown = do_genesDown,mydirname = "Macro/ctrl")

```

```{r}

 COL4A1 COL4A2 FN1 THBS1 SEMA4

genes = c("COL4A1","COL4A2" ,"FN1", "THBS1","THBS4","SEMA4A","SEMA4B","SEMA4C","SEMA4D")

for (gene in genes){
  
  p = compare_OneGene(object =obj_cafs,gene = gene,category = "category",cellname = gene)
   ggsave(file = paste0("cafs/_",gene,".pdf"), plot = p, dpi = 500, width = 7, height = 5)
  
}

 
load("Rdata/dudu.Rdata")

p1 = compare_OneGene(object =obj_cafs,gene = "COL4A1",category = "category",cellname = "COL4A1")
p2 = compare_OneGene(object =obj_cafs,gene = "COL4A2",category = "category",cellname = "COL4A2")
p3 = compare_OneGene(object =obj_cafs,gene = "FN1",category = "category",cellname = "FN1")
p4 = compare_OneGene(object =obj_cafs,gene = "THBS1",category = "category",cellname = "THBS1")
p5 = compare_OneGene(object =obj_cafs,gene = "SEMA4",category = "category",cellname = "SEMA4")

```



```{r}
def huage_adata_info(adata):
    mat=pd.DataFrame(data=adata.X.todense(),index=adata.obs_names,columns=adata.var_names)
    mat.to_csv("./seruat/mat.csv")
    meta=pd.DataFrame(data=adata.obs)
    meta.to_csv('./seruat/metadata.tsv',sep="\t")

    umap=pd.DataFrame(data=adata.obsm["X_umap"],index=adata.obs_names,columns=['umap_1','umap_2'])
    umap.to_csv('./seruat/position_'+"X_umap"+'.tsv',sep="\t")


```








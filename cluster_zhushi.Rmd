---
title: "rmarkdown"
output: html_document
editor_options: 
  chunk_output_type: console
---

rm(list = ls()[!ls() %in% c("seu.obj")])
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,warning = F,message = F)
```
### 1.è·å–ä¸´åºŠä¿¡æ¯ 

```{r}

#åšä¸ªè‡ªå·±çš„ä¸´åºŠä¿¡æ¯
```

### 2.æ‰¹é‡è¯»å–
```{r}


 #x3:hexiuzhi turned
#x:fuyonghua no_turned

#x4:guomeirong turned
#x5:wangshaoqiang no_turned
#zqx:maairong turned
  
  samples_list <- list()
                
  samples <- c("normal1","normal2","normal3","turned1","turned2","turned3")
# å¾ªç¯å¤„ç†æ¯ä¸ªæ–‡ä»¶å¤¹ï¼Œè¯»å–å¹¶å­˜å‚¨ä¸º seurat å¯¹è±¡ï¼Œå¹¶æ·»åŠ åˆ° seob_list
  for (sample in samples) {
  # è¯»å–æ•°æ®
    dataSimple <- Read10X(
    gene.column = 1,#å¯èƒ½ç‰ˆæœ¬ä¸åŒidä¼šä¸åŒ
    data.dir = str_c("import/data/", sample))
  # åˆ›å»º seurat å¯¹è±¡
    sample_obj <- CreateSeuratObject(
    counts = dataSimple,
    project = sample,
    min.cells = 5,  # å¯¹åŸºå› è¿‡æ»¤
    min.features = 200) # å¯¹ç»†èƒè¿‡æ»¤
  # å°† seurat å¯¹è±¡å­˜å…¥åˆ—è¡¨
    samples_list[[sample]] = sample_obj
  
  }

  sce.all = merge(samples_list[[1]],samples_list[-1])
  sce.all = JoinLayers(sce.all) #æŠŠlayeråˆå¹¶ï¼Œcount1 count2
 
  sce.all$sample =sce.all@active.ident#æ·»åŠ ä¸€åˆ—æ ‡è®°æ¥è‡ªå“ªä¸ªæ ·æœ¬ï¼Œä½†æ˜¯çœ‹è¿™ä¸€åˆ—æ˜¯å› å­ï¼Œä¸çŸ¥é“åé¢æœ‰é—®é¢˜æ²¡

  #save(sce.all,file = "Rdata/sce_all.Rdata")
  #rm(list = ls())
  



```

### 3.è´¨æ§æŒ‡æ ‡

```{r}

#çº¿ç²’ä½“
sce.all$percent.mt <- PercentageFeatureSet(sce.all, pattern = "^MT-")
#æ ¸ç³–ä½“,åªåšæ ‡è®°ï¼Œä¸€èˆ¬ä¸è¿‡æ»¤
sce.all$percent.rb <-PercentageFeatureSet(sce.all, pattern = "^RP[SL]")
#è¡€çº¢è›‹ç™½
sce.all$percent.hb <- PercentageFeatureSet(sce.all,pattern = "^HB[ABDEGMQZ]")

head(sce.all@meta.data, 3)

pdf("plot/è¿‡æ»¤å‰.pdf")
VlnPlot(sce.all, 
        features = c("nFeature_RNA",
                     "nCount_RNA", 
                     "percent.mt",
                     "percent.hb"
                     ),#""
        ncol = 3,pt.size = 0, group.by = "sample")
dim(sce.all)
dev.off


sce.all = subset(sce.all,subset = nFeature_RNA < 8000 &
                nCount_RNA > 500 &
                nCount_RNA < 40000 &
                percent.mt < 10 &
                percent.hb < 0.25 
               
                )
dim(sce.all)

pdf("plot/è¿‡æ»¤å.pdf")
VlnPlot(sce.all, 
        features = c("nFeature_RNA",
                     "nCount_RNA", 
                     "percent.mt"
                     ),
        ncol = 3,pt.size = 0, group.by = "sample")
dev.off



```

#### 4.æ•´åˆé™ç»´èšç±»åˆ†ç¾¤

```{r}
# å°†è™šæ‹Ÿå†…å­˜ä¸Šé™æå‡è‡³ 64GBï¼ˆéœ€ç³»ç»Ÿæ”¯æŒï¼‰
 #mem.maxVSize(vsize = 16384 * 4)

library(harmony)

sce.all = sce.all %>% 
NormalizeData() %>%  
FindVariableFeatures() %>%  
ScaleData(features = rownames(.)) %>%  
RunPCA(pc.genes = VariableFeatures(.))  %>%
RunHarmony("orig.ident") %>%
FindNeighbors(dims = 1:20, reduction = "harmony") %>% 
FindClusters(resolution = 0.6) %>% 
RunUMAP(dims = 1:20,reduction = "harmony") #%>% 
#RunTSNE(dims = 1:15,reduction = "harmony")
sce.all = test



ElbowPlot(sce.all)


```

#### 5.æ‰‹åŠ¨æ³¨é‡Š

```{r}
markercolor = c("#edf8b1","#2c7fb8")
temp = sce.all
df <- read.csv("../cca_blood/import/marker/markers.csv", header = FALSE, stringsAsFactors = FALSE)
df$V1 <- factor(df$V1, levels = levels(temp),ordered = T)
df <- df %>% arrange(V1)
genes = df$V2
p = markerDot(temp,genes,colors = markercolor)
p



myggsave(file = "plot/newfig/fig_5_Då›¾.pdf", plot = p, dpi = 600, width = 15,height = 5)




p = marker_heatmap(temp,genes,colors = markercolor)
p

myggsave(file = "plot/newfig/Supplementary_5_çƒ­å›¾.pdf", plot = p, dpi = 600, width = 15,height = 6)

umapColor = palette
temp = obj_macr

genes = c("MMP9","MMP14","SPP1")
plist = timeAllPlot(obj = subset(temp,category == "turned"),do_genesUp = genes,do_genesDown = genes,startGene = "M1-like" )

#============================================


genes = read.table("import/marker/markers.csv", header=F, sep=",",comment.char = "", check.names =FALSE)
colnames(genes) = c("cluster","gene")

p = plot_markers_heatmap(obj = sce.all,genes = genes)
p


pdf(file = "plot/ALL/çƒ­å›¾marker.pdf",width = 10,height = 8)
p
dev.off()
#æ³¨é‡Šçš„æ°”æ³¡å›¾
p = jjDotPlot(object = sce.all,
          gene  = genes$V2,
          anno = T,
          plot.margin = c(3,1,1,1),
          point.geom = T,
          tile.geom = F,
          x.text.angle = 90,#xå­—ä½“æ—‹è½¬
          id = "seurat_clusters",#çºµåæ ‡
          dot.col = c("#edf8b1","#2c7fb8")
          )
p

pdf(file = "plot/ALL/marker.pdf",width = 15,height = 10)
p
dev.off

writeLines(paste0(as.character(0:23),","))
names(markers)


celltype = read.csv("import/zhushi/zhushi.txt",sep=",",check.names =FALSE,header = F) #è‡ªå·±ç…§ç€DotPlotå›¾å¡«çš„
celltype


new.cluster.ids <- celltype$V2
names(new.cluster.ids) <- levels(sce.all)
sce.all <- RenameIdents(sce.all, new.cluster.ids)
sce.all$celltype = Idents(sce.all)

#æ–°å¢ä¸€åˆ—ï¼Œæ ·æœ¬ç±»å‹ ###***************************
library(stringr)

sce.all$category = ifelse(str_detect(sce.all$sample,"normal"),"normal","turned")


save(seu.obj,file = "Rdata/seu.obj.Rdata")


load(file = "Rdata/seu.obj.Rdata")
load(file = f)
p_shou <- DimPlot(seu.obj, 
              reduction = "umap", 
              label = TRUE, 
              pt.size = 0.5,cols = getClusterColor(8:18))
p_shou
pdf("plot/æ‰‹åŠ¨æ³¨é‡Š.pdf",width = 20,height = 16)
p_shou
dev.off

DimPlot(seu.obj, 
              reduction = "umap", 
              label = TRUE, 
              group.by = "category",
              pt.size = 0.2,cols = getClusterColor(c(3,9)))

rm(list = ls()[! ls() %in% c("seu.obj")])

```



#### 6.è‡ªåŠ¨æ³¨é‡Š

```{r fig.width= 12}
library(celldex)
library(SingleR)
ls("package:celldex")
#f = "ref_BlueprintEncode.RData"
#if(!file.exists(f)){
  ref <- celldex::BlueprintEncodeData()
#  save(ref,file = f)
#}
#ref <- get(load(f))
library(BiocParallel)
scRNA = sce.all
test = scRNA@assays$RNA$data

pred.scRNA <- SingleR(test = test, 
                      ref = ref,
                      labels = ref$label.main, 
                      clusters = scRNA@active.ident)
pred.scRNA$pruned.labels
#æŸ¥çœ‹æ³¨é‡Šå‡†ç¡®æ€§ 
plotScoreHeatmap(pred.scRNA, clusters=pred.scRNA@rownames, fontsize.row = 9,show_colnames = T)
new.cluster.ids <- pred.scRNA$pruned.labels
names(new.cluster.ids) <- levels(scRNA)
levels(scRNA)
scRNA <- RenameIdents(scRNA,new.cluster.ids)
levels(scRNA)


p2 <- DimPlot(scRNA, reduction = "umap",label = T,pt.size = 0.5) + NoLegend()+theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.title = element_blank(),
    axis.text = element_blank(),
    legend.position = "right",
    legend.title = element_blank(),
    plot.title = element_text(hjust = 0.5, face = "bold")
  ) +
  ggtitle("Modern t-SNE Plot")
p2
p0+p2+p_shou
pdf("plot/è‡ªåŠ¨æ³¨é‡Š.pdf",width = 20,height = 16)
p2
dev.off
```

#### 7.markeråŸºå› 

æ‰¾ä¸åŒç»†èƒç±»å‹é—´çš„å·®å¼‚åŸºå› 

```{r}


  allmarkers <- FindAllMarkers(sce.all, #only.pos = TRUE, åªè¿”å›æ­£
                               min.pct = 0.4, #è¿‡æ»¤æ¡ä»¶ï¼Œè‡³å°‘è¦åœ¨æŸä¸ªğŸˆ¶25%ç»†èƒè¡¨è¾¾
                               #logfc.threshold = 0.25#logFC>0.25
                               )
  
  test_allmarkers = allmarkers[allmarkers$avg_log2FC > 0.4 & allmarkers$pct.1 > 0.25 & allmarkers$cluster %in% c(6,15) & allmarkers$p_val_adj < 0.01,c("avg_log2FC","cluster", "p_val_adj", "gene")]
library(data.table)
fwrite(test_allmarkers, "export/Allmarkers_test33.csv")

sce.all <- subset(sce.all, idents = c("0" , "1" , "2" , "3" , "4" , "5" , "6" , "7",  "8" , "9" , "10", "11", "14", "15"  ,"19", "20", "21"))

 mem.maxVSize(vsize = 16384 * 4)

library(harmony)

sce.all = sce.all %>% 
NormalizeData() %>%  
FindVariableFeatures() %>%  
ScaleData(features = rownames(.)) %>%  
RunPCA(pc.genes = VariableFeatures(.))  %>%
RunHarmony("orig.ident") %>%
FindNeighbors(dims = 1:20, reduction = "harmony") %>% 
FindClusters(resolution = 0.8) %>% 
RunUMAP(dims = 1:20,reduction = "harmony") #%>% 

```

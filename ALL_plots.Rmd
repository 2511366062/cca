---
title: "ALL"
author: "lixiaokang"
date: "2025-04-09"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = T,warning = T)
```

##åŠ è½½é¢œè‰²

```{r}
library(RColorBrewer)

#æ‰©å±•brewer
palette <- colorRampPalette(brewer.pal(8, "Set2"))(24) 
original_palette <- paletteer_d("ggsci::nrc_npg") 
palette <- colorRampPalette(original_palette)(24)


```

## 1.ç»˜åˆ¶æ€»çš„UMAPå›¾

```{r}
library(scRNAtoolVis)
library(paletteer)


p = clusterCornerAxes(object = sce.all,
                  reduction = 'umap',
                  noSplit = T,#ä¸ç»„
                  clusterCol = 'celltype',
                  cellLabel = T,#è®¾ç½®äº†åˆ™åœ¨å›¾ä¸­æ ‡å‡ºæ¥
                  cellLabelSize = 10,#ç»†èƒžåçš„å¤§å°
                  pSize = 0.1,
                  arrowType='open',#åˆ†å¼€çš„ç®­å¤´
                  show.legend = F, #åˆ é™¤å›¾ä¾‹
                  
                  ) + scale_color_manual(values = palette)

p
pdf(file = "plot/ALL/æ‰€æœ‰ç»†èƒžçš„UMAP.pdf",width = 15,height = 10)
p
dev.off

```

## 1.ç»˜åˆ¶æ€»çš„ç°‡ UMAPå›¾

```{r}
library(scRNAtoolVis)
library(paletteer)


p0 = clusterCornerAxes(object = sce.all,
                  reduction = 'umap',
                  noSplit = T,#ä¸ç»„
                  clusterCol = 'seurat_clusters',
                  cellLabel = T,#è®¾ç½®äº†åˆ™åœ¨å›¾ä¸­æ ‡å‡ºæ¥
                  cellLabelSize = 10,#ç»†èƒžåçš„å¤§å°
                  pSize = 0.1,
                  arrowType='open',#åˆ†å¼€çš„ç®­å¤´
                  show.legend = F, #åˆ é™¤å›¾ä¾‹
                  
                  ) + scale_color_manual(values = palette)

p_two = p0 + p
pdf(file = "plot/ALL/ç°‡å’Œæ³¨é‡Šçš„UMAP111111.pdf",width = 15,height = 10)
p0
dev.off


```


## 2.ç»˜åˆ¶normalå’Œturnedçš„UMAPå›¾
```{r}


p = clusterCornerAxes(object = sce.all,
                  reduction = 'umap',
                  noSplit = F,
                  pSize = 0.1,
                  arrowType='open',
                  groupFacet = 'category',
                  clusterCol = 'celltype',
                  base_size = 25,
                  aspect.ratio = 1,#ç»˜å›¾çš„å®½é«˜æ¯”(æ­£æ–¹å½¢)ï¼Œé»˜è®¤NULL
                  relLength = 0.5 #xè½´yè½´çš„ç›¸å¯¹æŸä¸ªçš„é•¿åº¦ï¼Œ0-1
                  )+scale_color_manual(values = palette)

p
pdf(file = "plot/ALL/noturnedç»„å’Œturnedç»„çš„UMAP.pdf",width = 15,height = 10)
p
dev.off
```




## 3.ç»˜åˆ¶6ä¸ªæ ·æœ¬çš„UMAP
```{r}


p = clusterCornerAxes(object = sce.all,
                  reduction = 'umap',
                  noSplit = F,
                  pSize = 0.05,
                  arrowType='open',
                  groupFacet = 'sample',
                  clusterCol = 'celltype',
                  axes = "one",
                  themebg = "bwCorner",
                  base_size = 15,
                  aspect.ratio = 1,#ç»˜å›¾çš„å®½é«˜æ¯”(æ­£æ–¹å½¢)ï¼Œé»˜è®¤NULL
                  relLength = 0.5, #xè½´yè½´çš„ç›¸å¯¹æŸä¸ªçš„é•¿åº¦ï¼Œ0-1
                  )+scale_color_manual(values = palette)

p
pdf(file = "plot/ALL/6ä¸ªæ ·æœ¬çš„UMAP.pdf",width = 15,height = 10)
p
dev.off



```
## 4.ç»†èƒžæ¯”ä¾‹ç»Ÿè®¡å›¾
```{r}
#ç»Ÿè®¡ç»†èƒžä¸ªæ•°
dat = as.data.frame(table(Idents(sce.all)))
#lableè‡ªåŠ¨ç±»åž‹
dat$label = paste(dat$Var1,dat$Freq,sep = ":")
head(dat)
library(ggplot2)
library(paletteer)
#View(palettes_d_names)

p = ggplot(dat,aes(x = Freq,fill = Var1,y = Var1))+
  scale_fill_manual(values = palette)+#é¢œè‰²
  geom_bar(stat = "identity")+
  theme_bw()+
  geom_text(aes(x = 0,label = label),hjust = 0)+
  theme(axis.text.y = element_blank(),   # éšè—çºµåæ ‡åˆ»åº¦æ–‡å­—
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank(),# éšè—çºµåæ ‡åˆ»åº¦çº¿

    panel.grid.major = element_blank(),#éšè—èƒŒæ™¯ç½‘æ ¼
    panel.grid.minor = element_blank(),#éšè—èƒŒæ™¯ç½‘æ ¼
    legend.title = element_text(size = 0),
    legend.text = element_text(size = 18),
    #panel.border = element_blank(),
        )  
p

pdf(file = "plot/ALL/æ‰€æœ‰ç»†èƒžä¸ªæ•°ç»Ÿè®¡.pdf",width = 12,height = 9)
p
dev.off
```


#ç»Ÿè®¡ç»†èƒžæ¯”ä¾‹ã€ä¸ªæ•°

```{r}
# æ¯”ä¾‹å›¾


p1 = plot_category_bar(sce.all,factory = c("turned","normal"),position = "fill")
p2 = plot_category_bar(sce.all,factory = c("turned","normal"),position = "stack")
p3 = plot_category_bar(sce.all,factory = c("turned","normal"),position = "dodge")

pdf(file = "plot/ALL/bar_æ¡å½¢å›¾/å¯¹ç…§ç»„p3.pdf",width = 10,height = 8)
p3
dev.off


 
p1 = plot_sample_bar(sce.all,colors = palette,position = "fill" ) 
p2 = plot_sample_bar(sce.all,colors = palette,position = "stack" ) 
p3 = plot_sample_bar(sce.all,colors = palette,position = "dodge" ) 

pdf(file = "plot/ALL/bar_æ¡å½¢å›¾/æ ·æœ¬p1.pdf",width = 10,height = 8)
p1
dev.off
 
 
#ggThemeAssistGadget(p)




```


## 5.ç»Ÿè®¡tumorç»„ç»†èƒžæ•°é‡
```{r}


#ç»Ÿè®¡ç»†èƒžä¸ªæ•°
dat = sce.all@meta.data[sce.all$category == "turned",]
dat =  as.data.frame(table(dat$celltype))


#lableè‡ªåŠ¨ç±»åž‹
dat$label = paste(dat$Var1,dat$Freq,sep = ":")
head(dat)
library(ggplot2)
library(paletteer)
#View(palettes_d_names)

p = ggplot(dat,aes(x = Freq,fill = Var1,y = Var1))+
  scale_fill_manual(values = palette)+
  geom_bar(stat = "identity")+
  theme_bw()+
  geom_text(aes(x = 0,label = label),hjust = 0)+
  theme(axis.text.y = element_blank(),   # éšè—çºµåæ ‡åˆ»åº¦æ–‡å­—
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank(),# éšè—çºµåæ ‡åˆ»åº¦çº¿

    panel.grid.major = element_blank(),#éšè—èƒŒæ™¯ç½‘æ ¼
    panel.grid.minor = element_blank(),#éšè—èƒŒæ™¯ç½‘æ ¼
    legend.title = element_text(size = 0),
    legend.text = element_text(size = 18),
    #panel.border = element_blank(),
        )  
p


pdf(file = "plot/ALL/è½¬ç§»ç»„ç»†èƒžä¸ªæ•°ç»Ÿè®¡.pdf",width = 12,height = 9)
p
dev.off

```
## 6.ç»Ÿè®¡metastasisç»†èƒžæ•°é‡
```{r}

#ç»Ÿè®¡ç»†èƒžä¸ªæ•°

dat = sce.all@meta.data[sce.all$category == "no_turned",]
dat =  as.data.frame(table(dat$celltype))
#lableè‡ªåŠ¨ç±»åž‹
dat$label = paste(dat$Var1,dat$Freq,sep = ":")
head(dat)
library(ggplot2)
library(paletteer)
#View(palettes_d_names)

p = ggplot(dat,aes(x = Freq,fill = Var1,y = Var1))+
  scale_fill_manual(values = palette)+
  geom_bar(stat = "identity")+
  theme_bw()+
  geom_text(aes(x = 0,label = label),hjust = 0)+
  theme(axis.text.y = element_blank(),   # éšè—çºµåæ ‡åˆ»åº¦æ–‡å­—
        axis.ticks.y = element_blank(),
        axis.title.y = element_blank(),# éšè—çºµåæ ‡åˆ»åº¦çº¿

    panel.grid.major = element_blank(),#éšè—èƒŒæ™¯ç½‘æ ¼
    panel.grid.minor = element_blank(),#éšè—èƒŒæ™¯ç½‘æ ¼
    legend.title = element_text(size = 0),#å›¾ä¾‹æ ‡é¢˜å­—ä½“å¤§å°
    legend.text = element_text(size = 18),#å›¾ä¾‹å­—ä½“å¤§å°
    #panel.border = element_blank(),
        )  
p

pdf(file = "plot/ALL/éžè½¬ç§»ç»„ç»†èƒžç»Ÿè®¡.pdf",width = 12,height = 9)
p
dev.off

```
## 8.ç»†èƒžæ¯”ä¾‹æ¡å½¢å›¾ï¼ˆnormal turnedï¼‰

```{r}


#æŒ‰å¤§ç±»åˆ†ç»„
p = ggplot(sce.all@meta.data,aes(category,fill = celltype))+
  geom_bar(position = "fill", alpha = 0.9,width = 0.5)+
  scale_fill_manual(values = palette)+
  theme_classic()+
  coord_flip()+
  coord_fixed(ratio = 4)+ #çºµè½´é•¿åº¦æ˜¯æ¨ªè½´çš„4å€
  theme(legend.title = element_text(size = 20),
    legend.text = element_text(size = 18),
    axis.text.x = element_text(size = 16)
    )

p


pdf(file = "plot/ALL/turned_norturnedç»†èƒžæ¯”ä¾‹æ¡å½¢å›¾.pdf",width = 12,height = 9)
p
dev.off

```

## 9.ç»†èƒžæ¯”ä¾‹æ¡å½¢å›¾ï¼ˆ6ä¸ªæ ·æœ¬ï¼‰
```{r}
#æŒ‰æ ·æœ¬
p = ggplot(sce.all@meta.data,aes(sample,fill = celltype))+
  geom_bar(position = "fill", alpha = 0.9,width = 0.5)+
  scale_fill_manual(values = palette)+
  theme_classic()+
  coord_flip()+
  coord_fixed(ratio = 4)+ #çºµè½´é•¿åº¦æ˜¯æ¨ªè½´çš„4å€
  theme(legend.title = element_text(size = 20),
    legend.text = element_text(size = 18),
    axis.text.x = element_text(size = 16)
    )
p

pdf(file = "plot/ALL/5ä¸ªæ ·æœ¬ç»†èƒžæ¯”ä¾‹æ¡å½¢å›¾.pdf",width = 12,height = 9)
p
dev.off
```


## 13.markeråŸºå› çƒ­å›¾ï¼Œç±»ä¼¼äºŽæ°”æ³¡å›¾
```{r}
# äº‹ä¾‹æ•°æ®ï¼Œä»¥ä»–ä¸ºä¾‹top3pbmc.markers
library(tidyverse)
#æž„å»ºè¿™æ ·çš„æ•°æ®æ¡†
genes = read.table("import/makers/makers.txt", header=F, sep="\t",comment.char = "", check.names =FALSE)
colnames(genes) = c("cluster","gene")

p = jjDotPlot(object = sce.all,
          markerGene = genes,
          anno = T,
          plot.margin = c(3,1,1,1),
          point.geom = F,
          tile.geom = T,
          id = "seurat_clusters"#çºµåæ ‡
          )
p

pdf(file = "plot/ALL/markeråŸºå› çƒ­å›¾.pdf",width = 15,height = 10)
p
dev.off
```

## markeræ°”æ³¡å›¾ï¼Œçºµåæ ‡æ˜¯æ³¨é‡Šå¥½çš„celltype
```{r}

# äº‹ä¾‹æ•°æ®ï¼Œä»¥ä»–ä¸ºä¾‹top3pbmc.markers
library(tidyverse)
#æž„å»ºè¿™æ ·çš„æ•°æ®æ¡†
genes = read.table("import/marker/markers.csv", header=F, sep=",",comment.char = "", check.names =FALSE)
genes = genes$V2
genes = str_remove_all(genes," ")#åˆ é™¤ç©ºæ ¼
p = jjDotPlot(object = sce.all,
          gene  = genes,
          anno = T,
          plot.margin = c(3,1,1,1),
          point.geom = T,
          tile.geom = F,
          id = "celltype",#çºµåæ ‡
          dot.col = c("#edf8b1","#2c7fb8")
          )
p

pdf(file = "plot/ALL/markeråŸºå› æ°”æ³¡å›¾.pdf",width = 15,height = 10)
p
dev.off
```

## markerçƒ­å›¾
```{r}
# 
library(tidyverse)
#æž„å»ºè¿™æ ·çš„æ•°æ®æ¡†
genes = read.table("import/marker/markers.csv", header=F, sep=",",comment.char = "", check.names =FALSE)
genes = genes$V2
genes = str_remove_all(genes," ")#åˆ é™¤ç©ºæ ¼
p = jjDotPlot(object = sce.all,
          gene  = genes,
          anno = T,
          plot.margin = c(3,1,1,1),
          point.geom = F,
          tile.geom = T,
          id = "celltype",#çºµåæ ‡
          dot.col = c("#edf8b1","#2c7fb8")
          )
p

pdf(file = "plot/ALL/markeråŸºå› çƒ­å›¾.pdf",width = 15,height = 10)
p
dev.off

```



## KEGGå¯Œé›†åˆ†æž
```{r}

all_diff = diff_we(object = sce.all,
                   ident_1 = "turned",
                   ident_2 = "normal",
                   category = "category")

#tagGene = c("SPP1","CXCR4","S100A8","TIMP1","FOS","JUN","CTSD","LGALS3","S100A11")

#plots = getMyHSplot(object = all_diff,genes = tagGene)
#rm(list = ls()[!ls() %in% c("sce.all","obj_cd8")])
p = goodFuji(all_diff,tag = "up",colors = c("#e8c073",
"#d5e873",
"#e88673",
"#739ae8"
))
p

pdf(file = "plot/ALL/ä¸Šè°ƒåŸºå› å¯Œé›†åˆ†æžGOå’ŒKEGG.pdf",width = 20,height = 15)
p
dev.off






```

## æ¯ä¸ªåŸºå› åœ¨ä¸åŒåˆ†ç»„çš„è¡¨è¾¾æƒ…å†µ
```{r}
genes = c( "ANXA1","S100A4", "S100A8", "S100A9")

p = featureCornerAxes(object = sce.all,reduction = 'umap',
                  groupFacet ="category",
                  relLength = 0.5,
                  relDist = 0.2,
                  #axes = 'one',
                  features = genes,
                  minExp = 0,maxExp = 6,
                  pSize = 0.1,
                  low = "#edf8b1",
                  high = "#2c7fb8"
                  )

p 

pdf(file = "plot/ALL/ä¸€äº›åŸºå› é›†çš„å¯Œé›†æƒ…å†µ.pdf",width = 15,height = 10)
p
dev.off
```





## 10.æ¯ä¸ªç°‡çš„top3åŸºå› çƒ­å›¾
```{r}


library(tidyverse)
top3.makers= allmarkers %>% group_by(cluster) %>% top_n(4,wt = avg_log2FC)

p = averageHeatmap(object=sce.all,
               markerGene = top3.makers$gene,#æŒ‡å®šåŸºå› 
               gene.order = top3.makers$gene,#æŒ‡å®šé¡ºåº
               htCol = c("#9D7660FF","#FEB5A2FF","#ED444AFF"),#å˜åŒ–é¢œè‰²
               annoCol = T,#ç»†èƒžæ ‡ç­¾é€‰è‡ªå·±çš„é¢œè‰²
               myanCol = paletteer_d("ggthemes::Red_Blue_Brown")[1:11]
                )
p

pdf(file = "plot/ALL/top3Gene_heatmap.pdf",width = 12,height = 9)
p
dev.off

```
## 11.åˆ†é¡µçš„top5åŸºå› 
```{r}

topMarkers = FindAllMarkers(sce.all, #only.pos = TRUE, åªè¿”å›žæ­£
                               min.pct = 0.4, #è¿‡æ»¤æ¡ä»¶ï¼Œè‡³å°‘è¦åœ¨æŸä¸ªðŸˆ¶25%ç»†èƒžè¡¨è¾¾
                               #logfc.threshold = 0.25#logFC>0.25
                               )
p = markerVolcano(markers = topMarkers,
              topn = 5,
              labelCol = palette[1:12],
              pforce = 5,#æ­£åˆ†æ•£ç¨‹åº¦
              nforce = 5,#è´Ÿåˆ†æ•£ç¨‹åº¦
              )
p
pdf(file = "plot/ALL/top5åŸºå› .pdf",width = 15,height = 10)
p
dev.off

```
## 12.å¥½çš„åˆ†é‡Žæ ‡è®°åŸºå› 
```{r}
 
pdf(file = "plot/ALL/top5_gene_another.pdf",width = 15,height = 10)
jjVolcano(diffData = allmarkers,
              tile.col = paletteer_d("ggthemes::Red_Blue_Brown")[1:11],
          flip = F)#Tåˆ™è½¬åˆ¶å›¾è¡¨
dev.off
```

### 12.1 æ ‡è®°åŸºå› é›·è¾¾å›¾
```{r}
p = jjVolcano(diffData = allmarkers,
              tile.col = paletteer_d("ggthemes::Red_Blue_Brown")[1:11],
          flip = F,#Tåˆ™è½¬åˆ¶å›¾è¡¨
          size = 3.5,
          fontface = 'italic',
          polar = T
          )+ ylim(-8,10)
p
pdf(file = "plot/ALL/top5_gene_another_leida.pdf",width = 15,height = 15)
p
dev.off
```









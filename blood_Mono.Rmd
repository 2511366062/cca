---
title: "Mye"
author: "lixiaokang"
date: "2025-04-22"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## 1. èšç±»åˆ†æ
```{r}
library(harmony)

obj_mono = subset(sce.all, celltype == "Mono")
obj_mono = obj_mono %>% 
    NormalizeData() %>%  
    FindVariableFeatures() %>%  
    ScaleData(features = rownames(.)) %>%  
    RunPCA(pc.genes = VariableFeatures(.))  %>%
    RunHarmony("orig.ident") %>%
    FindNeighbors(dims = 1:15, reduction = "harmony") %>% 
    FindClusters(resolution = 0.7) %>% 
    RunUMAP(dims = 1:15,reduction = "harmony") #%>% 

obj_mono = subset(obj_mono,seurat_clusters == 0|
                  seurat_clusters == 1|
                  seurat_clusters == 2|
                   seurat_clusters == 3|
                     seurat_clusters == 4|
                     seurat_clusters == 5|
                     seurat_clusters == 6|
                     seurat_clusters == 7|
                     seurat_clusters == 8|
                     seurat_clusters == 9|
                    seurat_clusters == 10
                    )

#0 - 13ä¸ªç°‡

```


## æ³¨é‡Š
```{r}

markers <- FindAllMarkers(obj_mono, #only.pos = TRUE, åªè¿”å›æ­£
                               min.pct = 0.25, #è¿‡æ»¤æ¡ä»¶ï¼Œè‡³å°‘è¦åœ¨æŸä¸ªğŸˆ¶25%ç»†èƒè¡¨è¾¾
                               #logfc.threshold = 0.25#logFC>0.25
                               )
  
    test_markers = markers[markers$avg_log2FC > 0.4 & 
                             markers$pct.1 > 0.25  & 
                             markers$cluster %in% 10:12&
                             markers$p_val_adj < 0.01,c("avg_log2FC","cluster", "p_val_adj", "gene")]
library(data.table)
fwrite(test_markers, "export/mono(10-12).csv")
writeLines(paste0(as.character(0:12),","))


#çƒ­å›¾

genes = read.table("import/marker/mono_markers.csv", header=F, sep=",",comment.char = "", check.names =FALSE)
colnames(genes) = c("cluster","gene")
genes$gene = str_replace_all(genes$gene," ","")

p = plot_markers_heatmap(obj = obj_mono,genes = genes,min_max  = c(0,1,4))
p

pdf(file = "plot/Mono/çƒ­å›¾marker.pdf",width = 8,height = 10)
p
dev.off()


#æ³¨é‡Š
obj_mono= zhushi(object = obj_mono,file = "import/zhushi/mono_zhushi.txt")





# åˆ†ç°‡å›¾
p0 = clusterCornerAxes(object = obj_mono,
                  reduction = 'umap',
                  noSplit = T,#ä¸ç»„
                  clusterCol = 'seurat_clusters',
                  cellLabel = T,#è®¾ç½®äº†åˆ™åœ¨å›¾ä¸­æ ‡å‡ºæ¥
                  cellLabelSize = 10,#ç»†èƒåçš„å¤§å°
                  pSize = 0.1,
                  arrowType='open',#åˆ†å¼€çš„ç®­å¤´
                  show.legend = T, #åˆ é™¤å›¾ä¾‹
                  
                  ) + scale_color_manual(values = palette)






#æ³¨é‡Šå›¾
p1 = clusterCornerAxes(object = obj_mono,
                  reduction = 'umap',
                  noSplit = T,#ä¸ç»„
                  clusterCol = 'celltype',
                  cellLabel = T,#è®¾ç½®äº†åˆ™åœ¨å›¾ä¸­æ ‡å‡ºæ¥
                  cellLabelSize = 5,#ç»†èƒåçš„å¤§å°
                  pSize = 0.1,
                  arrowType='open',#åˆ†å¼€çš„ç®­å¤´
                  show.legend = T, #åˆ é™¤å›¾ä¾‹
                  
                  ) +
scale_color_manual(values = palette)
p1

p0 + p1

pdf(file = "plot/Mono/UMAP_.pdf",width = 15,height = 10)
p0 + p1
dev.off

pdf(file = "plot/Mono/UMAP__.pdf",width = 10,height = 8)
p1
dev.off





```

## ç”»å›¾ï¼šUMAPå¯¹æ¯” ç»†èƒæ•°é‡æ¡å½¢å›¾ æ¯”ä¾‹å›¾
```{r}

plist = plot_bar_all(sce.all,colors = palette)

plistNames = names(plist)

for(name in plistNames) {
  
  filename = paste0("plot/Mono/æ¡å½¢å›¾/", name, ".pdf")
  
  pdf(file = filename,width = 10,height = 8)
  p = plist[[name]]
  print(p)
  dev.off()
  
}




```
## markeråŸºå› æ°”æ³¡å›¾å’Œçƒ­å›¾
```{r}
list = heatmap_paopaotu(obj = obj_mono,file = "import/marker/mono_markers.csv")

pdf(file = "plot/Mono/markeråŸºå› æ°”æ³¡å›¾.pdf",width = 13,height = 8)
list$paopao
dev.off

pdf(file = "plot/Mono/markeråŸºå› çƒ­å›¾.pdf",width = 12,height = 6)
list$heatmap
dev.off

```

## å·®å¼‚è¡¨è¾¾åˆ†æ
```{r}

#æ‰€æœ‰çš„
mono_diff = diff_we(object = obj_mono,
                   ident_1 = "turned",
                   ident_2 = "normal",
                   category = "category",
                  log2FC = 0.4)
 genes = rownames(mono_diff)[mono_diff$tag %in% c("up","down")]
 
 genesUp = get_upgene(object = mono_diff)
 genesdown = rownames(mono_diff)[mono_diff$tag %in% c("down")]
 
 
 do_genesUp = c("CX3CR1", "RHOC", "CTSL", "STAT1", "GBP1")
 
 do_genesDown =  c(
  "CD14",       # å•æ ¸ç»†èƒè¡¨é¢æ ‡å¿—ç‰©ï¼Œä¸‹è°ƒå‰Šå¼±å…ç–«ç›‘è§†å’ŒæŠ—è‚¿ç˜¤åŠŸèƒ½
  "HLA-DQA2",   # MHC IIç±»åˆ†å­ï¼Œä¸‹è°ƒå‡å°‘æŠ—åŸå‘ˆé€’ï¼ŒæŠ‘åˆ¶Tç»†èƒæ¿€æ´»
  "TNFAIP3",    # TNFÎ±è¯±å¯¼è›‹ç™½3ï¼Œä¸‹è°ƒå¢å¼ºNF-ÎºBä¿¡å·ï¼Œä¿ƒè¿›ä¿ƒè½¬ç§»ç‚ç—‡
  "CXCR4",      # è¶‹åŒ–å› å­å—ä½“ï¼Œä¸‹è°ƒå¯èƒ½å½±å“å•æ ¸ç»†èƒå½’å·¢ä½†å¤æ‚ï¼ˆéœ€éªŒè¯ï¼‰
  "CEBPD",      # è½¬å½•å› å­ï¼Œä¸‹è°ƒæŠ‘åˆ¶æŠ—è‚¿ç˜¤å•æ ¸ç»†èƒåˆ†åŒ–
  "KLF10"       # è°ƒæ§ç»†èƒå‡‹äº¡ï¼Œä¸‹è°ƒä¿ƒè¿›å•æ ¸ç»†èƒå­˜æ´»å’Œä¿ƒè½¬ç§»è¡¨å‹
)
 
 
 ls_hs = getMyHSplot(object = mono_diff,genes = c(do_genesDown,do_genesUp))
 
 pdf("plot/Mono/ä¿ƒè½¬ç§»é‡ç‚¹åŸºå› çš„ç«å±±å›¾.pdf",width = 10,height = 8)
ls_hs$p1
dev.off



#umapå›¾å±•ç¤ºåŸºå› è¡¨è¾¾æƒ…å†µ
p = featureCornerAxes(object = obj_mono,reduction = 'umap',
                  groupFacet ="category",
                  relLength = 0.5,
                  relDist = 0.2,
                  axes = 'one',
                  features = do_genesUp,
                  minExp = 0,maxExp = 4,
                  pSize = 0.1,
                  low = "#326087",
                  high = "#E64B35"
                  )

pdf("plot/Mono/ä¿ƒè½¬ç§»ä¸Šè°ƒåŸºå› è¡¨è¾¾æƒ…å†µ.pdf",width = 10,height = 12)
p
dev.off



p = featureCornerAxes(object = obj_mono,reduction = 'umap',
                  groupFacet ="category",
                  relLength = 0.5,
                  relDist = 0.2,
                  axes = 'one',
                  features = do_genesDown,
                  minExp = 0,maxExp = 4,
                  pSize = 0.1,
                  low = "#326087",
                  high = "#E64B35"
                  )

pdf("plot/Mono/ä¿ƒè½¬ç§»ä¸‹è°ƒåŸºå› è¡¨è¾¾æƒ…å†µ.pdf",width = 10,height = 15)
p
dev.off



#çƒ­å›¾å±•ç¤º
DoHeatmap(obj_mono, features = do_genesUp) + NoLegend()+
  scale_fill_gradientn(colors = c("#2fa1dd", "white", "#f87669"))
```


#å¯Œé›†åˆ†æ
```{r}


plist = all_Go_KEGG(object = mono_diff)


  for (pname in names(plist)) {
    
  
    filename = paste0("plot/Mono/GO_KEGGå¯Œé›†åˆ†æ/", pname,"_.pdf")
    pdf(file = filename,width = 10,height = 18)
    p = plist[[pname]]
    print(p)
    dev.off()
    
  }

```




## å¤šåˆ†ç»„å¤šåŸºå› ç›¸çº¿å›¾
```{r}





tlist = two_group_genes_viloin_all(obj = obj_mono,color = palette,genes = do_genesUp)

tlist_down = two_group_genes_viloin_all(obj = obj_mono,color = palette,genes = do_genesDown)

for (i in 1 : length(tlist)) {
  cellname = names(tlist)[i]
  pdf(paste0("plot/Mono/ä¸Šè°ƒåŸºå› åœ¨äºšç¾¤ä¸­çš„å¯¹æ¯”/p", i, ".pdf"),width = 10,height = 7)
  p = tlist[[i]]
  print(p)
  dev.off()
  
}

for (i in 1 : length(tlist_down)) {
  cellname = names(tlist_down)[i]
  pdf(paste0("plot/Mono/ä¸‹è°ƒåŸºå› åœ¨äºšç¾¤ä¸­çš„å¯¹æ¯”/p", i, ".pdf"),width = 12,height = 8)
  p = tlist_down[[i]]
  print(p)
  dev.off()
  
}






```



## å°æç´å›¾
```{r}
library(stringr)
 
haha = compare_OneGene_all(obj_macr,genes = do_genesDown)

haha2 = compare_OneGene_all(obj_macr,genes = do_genesUp)

for(cellname in c(levels(obj_macr))) {
  
  
  for (gene in do_genesDown) {
    
    clean_cellname = str_replace_all(cellname, "[/ +]", "")#åˆ é™¤éæ³•å­—ç¬¦"/" å’Œ" " "+"
    filename = paste0("plot/macrophage/å•ä¸ªä¸‹è°ƒåŸºå› åœ¨ä¸åŒäºšç¾¤ä¸­çš„å¯¹æ¯”/p_(", clean_cellname,")_",gene,"_.pdf")
    pdf(file = filename,width = 8,height = 6)
    p = haha[[cellname]][[gene]]
    print(p)
    dev.off()
    
  }
  
  
}



for(cellname in c(levels(obj_macr))) {
  
  
  for (gene in do_genesUp) {
    
    clean_cellname = str_replace_all(cellname, "[/ +]", "")#åˆ é™¤éæ³•å­—ç¬¦"/" å’Œ" " "+"
    filename = paste0("plot/macrophage/å•ä¸ªä¸Šè°ƒåŸºå› åœ¨ä¸åŒäºšç¾¤ä¸­çš„å¯¹æ¯”/p_(", clean_cellname,")_",gene,"_.pdf")
    pdf(file = filename,width = 8,height = 6)
    p = haha2[[cellname]][[gene]]
    print(p)
    dev.off()
    
  }
  
  
}

```


#GSEAå¯Œé›†åˆ†æ
```{r}
all_gene = rownames(mono_diff)
all_ENTREZID = bitr(all_gene, 
                      fromType = "SYMBOL", 
                      toType = "ENTREZID", 
                      OrgDb = org.Hs.eg.db)
mono_diff_log2FC = mono_diff[which(rownames(mono_diff) %in% all_ENTREZID$SYMBOL),]

logFC_dat = data.frame(SYMBOL = rownames(mono_diff_log2FC),log2FC = mono_diff_log2FC$avg_log2FC)

finally_dat = merge(logFC_dat,all_ENTREZID,by = "SYMBOL")
finally_vector = as.vector(finally_dat$log2FC)
names(finally_vector) = as.vector(finally_dat$ENTREZID)
finally_vector = sort(finally_vector,decreasing = T)

GSEA_KEGG <- gseKEGG(finally_vector, organism = 'hsa', pvalueCutoff = 0.05,pAdjustMethod = "BH")

#ä½¿ç”¨GOæ•°æ®åº“å¯Œé›†åˆ°äº†
GSEA_GO <- gseGO(
  geneList = finally_vector,
  OrgDb = org.Hs.eg.db,
  ont = "BP",  # Biological Process
  pvalueCutoff = 0.05
)

# ä½¿ç”¨KEGGæ•°æ®åº“é‡æ–°è¿è¡ŒgseKEGG,è¿™é‡Œæ²¡æœ‰å¯Œé›†åˆ°
GSEA_KEGG <- gseKEGG(
  geneList = finally_vector,
  organism = "hsa",
  pvalueCutoff = 0.08 #0.25
)


library(clusterProfiler)
library(org.Hs.eg.db)
#devtools::install_github("junjunlab/GseaVis")
library("GseaVis")

 p = dotplotGsea(data=GSEA_KEGG,topn=5,add.seg = T)
pdf(file = "plot/Mono/Tç»†èƒçš„GSEAå¯Œé›†åˆ†æçš„TOP10.pdf",width = 10,height = 10)
 p
dev.off



key_metastasis_pathways <- c(
  "Ribosome",              # è°ƒæ§ç»†èƒè¿ç§»ã€ä¾µè¢­å’ŒEMT
  "Chagas disease"       # é©±åŠ¨ç‚ç—‡ååº”å’ŒæŠ—å‡‹äº¡ï¼Œä¿ƒè¿›è½¬ç§»å¾®ç¯å¢ƒ
  
)

terms = GSEA_KEGG@result[GSEA_KEGG@result$Description %in% key_metastasis_pathways,]$ID

gseaNb(object=GSEA_KEGG,
geneSetID='hsa05134',
newGsea=T)











p = gseaNb(object=GSEA_KEGG,
geneSetID=terms,
subPlot=2,
termWidth=35,
curveCol = palette[1:9],
legend.position=c(0.8,0.8))


pdf(file = "plot/Mono/Monoç»†èƒçš„GSEAå¯Œé›†åˆ†æ:åªå¯Œé›†åˆ°2é€šè·¯.pdf",width = 15,height = 8)
 p
dev.off
```






## å±•ç¤ºæ¯ä¸ªç»†èƒç¾¤çš„topåŸºå› 
```{r}

Mye_allmarkers <- FindAllMarkers(obj_mono, #only.pos = TRUE, åªè¿”å›æ­£
                               min.pct = 0.4, #è¿‡æ»¤æ¡ä»¶ï¼Œè‡³å°‘è¦åœ¨æŸä¸ªğŸˆ¶25%ç»†èƒè¡¨è¾¾
                               #logfc.threshold = 0.25#logFC>0.25
                               )
p = markerVolcano(markers = Mye_allmarkers,
              topn = 5,
              labelCol = palette)

pdf(file = "plot/Mono/top5åŸºå› .pdf",width = 20,height = 7)
p
dev.off
```



#å¤šåˆ†ç»„å¤šåŸºå› çš„å·®å¼‚åŸºå› æ¯”è¾ƒ
```{r}



```


#æ‹Ÿæ—¶åºåˆ†æï¼šslingshort

```{r}




library(slingshot)
library(SingleCellExperiment)
library(tidyverse)
library(RColorBrewer)



obj_mono_turned = subset(obj_mono, obj_mono$category == "turned")




hvg_genes <- VariableFeatures(obj_mono_turned)

 #åœ¨è¿™é‡Œä¸ºäº†å‡å°‘è®¡ç®—å‹åŠ›ï¼Œæˆ‘ä»¬æŠŠé«˜å˜åŸºå› æå–å‡ºæ¥
# ä½ å¯ä»¥è·Ÿæˆ‘ä¸€æ ·ä» scale.data ä¸­æå–ï¼Œä¹Ÿå¯ä»¥ç›´æ¥åœ¨ seurat å¯¹è±¡ä¸­æ‰¾å‡ºæ¥
scale.data <- obj_mono_turned@assays$RNA$scale.data
scale.gene <- rownames(scale.data)

counts <- scobj@assays$RNA@counts
counts <- counts[scale.gene,]

# å°†è¡¨è¾¾çŸ©é˜µè½¬æ¢ä¸ºSingleCellExperimentå¯¹è±¡
# è¾“å…¥éœ€è¦countsçŸ©é˜µï¼Œå¦åˆ™å½±å“ä¸‹æ¸¸åˆ†æ
sim <- SingleCellExperiment(assays = List(counts = counts)) 
sim <- SingleCellExperiment(obj_mono_turned)


sce <- as.SingleCellExperiment(obj_mono_turned)


sim <- slingshot(sce, 
                 clusterLabels = 'celltype',  # é€‰æ‹©colDataä¸­ç»†èƒæ³¨é‡Šçš„åˆ—å
                 reducedDim = 'UMAP',  
                 start.clus= "Naive/Central Memory",  # é€‰æ‹©èµ·ç‚¹
                 end.clus = NULL     # è¿™é‡Œæˆ‘ä»¬ä¸æŒ‡å®šç»ˆç‚¹
                )     
sds <- SlingshotDataSet(sim)


#çœ‹çœ‹æœ‰å‡ æ¡
sim$slingPseudotime_1





#


pdf(file = "plot/Mono/æ‹Ÿæ—¶åºåˆ†æ/p3.pdf",width = 10,height = 8)

        colors <- colorRampPalette(brewer.pal(11,'Spectral')[-6])(100) # æˆ‘ä»¬æŠŠè¿™äº›é¢œè‰²å˜æˆ100ä¸ªæ¢¯åº¦ï¼Œæ¨¡æ‹Ÿæ¸å˜è‰²
        plotcol <- colors[cut(sim$slingPseudotime_3, breaks=100)] # è¿™é‡Œæˆ‘ä»¬ç”¨cutå‡½æ•°æŠŠ lineage2 åˆ†å‰²æˆ100ä¸ªåŒºé—´ï¼ŒåŒä¸€åŒºé—´çš„ç»†èƒç»™ä¸åŒä¸€ä¸ªé¢œè‰²
        plotcol[is.na(plotcol)] <- "lightgrey" # ä¸å±äº lineage3 çš„ç‚¹ä¸ºNAï¼Œæˆ‘ä»¬æŠŠä»–ä»¬å˜æˆç°è‰²
        plotcol
        
        plot(reducedDims(sim)$UMAP, col = plotcol, pch=16, asp = 1,xaxt = "n",   # éšè—xè½´åˆ»åº¦çº¿å’Œæ ‡ç­¾
             yaxt = "n",   # éšè—yè½´åˆ»åº¦çº¿å’Œæ ‡ç­¾
             xlab = "",    # éšè—xè½´æ ‡ç­¾
             ylab = "" )    # éšè—yè½´æ ‡ç­¾
        lines(SlingshotDataSet(sim), lwd=2, col=brewer.pal(9,"Set1"))


dev.off



#åŠ ä¸€ä¸ªUMAPå›¾
p1 = clusterCornerAxes(object = obj_mono_turned,
                  reduction = 'umap',
                  noSplit = T,#ä¸ç»„
                  clusterCol = 'celltype',
                  cellLabel = F,#è®¾ç½®äº†åˆ™åœ¨å›¾ä¸­æ ‡å‡ºæ¥
                  cellLabelSize = 5,#ç»†èƒåçš„å¤§å°
                  pSize = 0.1,
                  arrowType='open',#åˆ†å¼€çš„ç®­å¤´
                  show.legend = T, #åˆ é™¤å›¾ä¾‹
                  
                  ) +
scale_color_manual(values = palette)

pdf(file = "plot/Mono/æ‹Ÿæ—¶åºåˆ†æ/UMAP.pdf",width = 10,height = 8)
p1
dev.off

```



## æ‹Ÿæ—¶åºåˆ†æ
æ„å»ºMonocle3æ‰€éœ€æ•°æ®
expression_matrixï¼šè¡Œæ˜¯geneï¼Œåˆ—æ˜¯cellçš„è¡¨è¾¾çŸ©é˜µ
cell_metadata:å¯¹åº”Seuratå¯¹è±¡çš„meta.dataä¿¡æ¯
gene_metadata:åŸºå› åç§°ä¿¡æ¯ï¼Œå¯ç”¨Gene symbol
```{r}

cds = getMonocleObj(obj = subset(obj_t,category == "turned"),startGene = "Tcm")
pUMAP = plotUMAP(cds)
plist_up = plotsChangeGenes(cds,do_genesUp)
plist_down = plotsChangeGenes(cds,do_genesDown)
yiwei_up = plotOneWeiCHangeGene(cds,startGene = "Tcm",genes = do_genesUp)
yiwei_down = plotOneWeiCHangeGene(cds,startGene = "Tcm",genes = do_genesDown)

pdf(file = "plot/time/t/turned/æ€»ä½“è½¨è¿¹åˆ†æ.pdf",width = 10,height = 8)
pUMAP
dev.off()


for(gene in do_genesUp) {
  filename = paste0("plot/time/t/turned/up/umap/",gene,".pdf")
  pdf(file =filename,width = 8,height = 6)
  p = plist_up[[gene]]
  print(p)
  dev.off()
  
}



for(gene in do_genesDown) {
  filename = paste0("plot/time/t/turned/down/umap/",gene,".pdf")
  pdf(file =filename,width = 8,height = 6)
  p = plist_down[[gene]]
  print(p)
  dev.off()
  
}


for(gene in do_genesUp) {
  filename = paste0("plot/time/t/turned/up/yiwei/",gene,".pdf")
  pdf(file =filename,width = 8,height = 6)
  p = yiwei_up[[gene]]
  print(p)
  dev.off()
  
}


for(gene in do_genesDown) {
  filename = paste0("plot/time/t/turned/down/yiwei/",gene,".pdf")
  pdf(file =filename,width = 8,height = 6)
  p = yiwei_down[[gene]]
  print(p)
  dev.off()
  
}


plist = timeAllPlot(obj = subset(obj_t,category == "turned"),
            startGene = "Tcm",do_genesUp = do_genesUp,do_genesDown = do_genesDown)

outTimeAllPlot(plist,"t/turned",do_genesUp = do_genesUp,do_genesDown = do_genesDown )

  

mkdir -p plot/time/macro/normal/up/umap/
mkdir -p  plot/time/macro/normal/down/umap/
mkdir -p  plot/time/macro/normal/up/yiwei/
mkdir -p  plot/time/macro/normal/down/yiwei/
  
mkdir -p plot/time/macro/turned/up/umap/
mkdir -p  plot/time/macro/turned/down/umap/
mkdir -p  plot/time/macro/turned/up/yiwei/
mkdir -p  plot/time/macro/turned/down/yiwei/
  

```


#æ‹Ÿæ—¶åºåˆ†æ
```{r}
library(SeuratWrappers)
library(monocle3)
# å°† Seurat å¯¹è±¡ seob_subset è½¬æ¢ä¸º Monocle 3 çš„ cell_data_set å¯¹è±¡
cds <- as.cell_data_set(obj_t,
                         #assay = "SCT",
                         reductions = c("pca", "umap"),
                         default.reduction = "umap"
                         )
# æ·»åŠ åŸºå› ä¿¡æ¯
rowData(cds) <- data.frame(
  row.names = rownames(cds),
  gene_short_name = rownames(cds)
)
# èšç±»ä¿¡æ¯æ— æ³•å®Œæ•´è½¬ç§»è¿‡æ¥ï¼Œä½¿ç”¨ cluster_cells é‡æ–°èšç±»
cds <- cluster_cells(cds, reduction_method = "UMAP", resolution = 0.3)


#use_partitionï¼šFï¼Œåˆ™ä¸åˆ†éš”ã€‚close_loopï¼šå…³é—­cycleç»“æ„
cds <- learn_graph(cds, use_partition = F, close_loop = T)

# a helper function to identify the root principal points:
get_earliest_principal_node <- function(cds, cell_type){
  cell_ids <- which(colData(cds)[, "cell_type"] == cell_type)
  
  closest_vertex <-
  cds@principal_graph_aux[["UMAP"]]$pr_graph_cell_proj_closest_vertex
  closest_vertex <- as.matrix(closest_vertex[colnames(cds), ])
  root_pr_nodes <-
  igraph::V(principal_graph(cds)[["UMAP"]])$name[as.numeric(names
  (which.max(table(closest_vertex[cell_ids,]))))]
  
  root_pr_nodes
}
cds <- order_cells(cds, 
                   root_pr_nodes = get_earliest_principal_node(cds, "Tcm"))



```







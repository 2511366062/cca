---
title: "CD8 -CD4 - plasma"
author: "lixiaokang"
date: "2025-04-22"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## 1. èšç±»åˆ†æ
```{r}
library(harmony)
 mem.maxVSize(vsize = 16384 * 4)
 #é¢œè‰²
original_palette <- paletteer_d("ggthemes::Red_Blue_Brown") 
extended_palette <- colorRampPalette(original_palette)(14)
 
obj_cd4 = one_to_all(seu.obj,"CD4",0.5)
obj_cd8 = one_to_all(seu.obj,"CD8",0.5)
obj_bp = one_to_all(seu.obj,c("B","Plasma"),0.5)

#0 - 13ä¸ªç°‡

```


## æ³¨é‡Š
```{r}

#æ‰©å±•palette
original_palette <- paletteer_d("ggthemes::Red_Blue_Brown") 
extended_palette <- colorRampPalette(original_palette)(14)





genes = read.table("plot/Mye/makers.txt", header=F, sep="\t",comment.char = "", check.names =FALSE)
colnames(genes) = c("cluster","gene")

#æ³¨é‡Šçš„æ°”æ³¡å›¾
p = jjDotPlot(object = obj_mye,
          markerGene = genes,
          anno = T,
          plot.margin = c(3,1,1,1),
          point.geom = T,
          tile.geom = F,
          id = "seurat_clusters",#çºµåæ ‡
          dot.col = c("#edf8b1","#2c7fb8")
          )
p


pdf(file = "plot/Mye/markeråŸºå› æ°”æ³¡å›¾.pdf",width = 15,height = 10)
p
dev.off


# åˆ†ç°‡å›¾
p0 = clusterCornerAxes(object = obj_mye,
                  reduction = 'umap',
                  noSplit = T,#ä¸ç»„
                  clusterCol = 'seurat_clusters',
                  cellLabel = T,#è®¾ç½®äº†åˆ™åœ¨å›¾ä¸­æ ‡å‡ºæ¥
                  cellLabelSize = 10,#ç»†èƒåçš„å¤§å°
                  pSize = 0.1,
                  arrowType='open',#åˆ†å¼€çš„ç®­å¤´
                  show.legend = T, #åˆ é™¤å›¾ä¾‹
                  
                  ) + scale_color_manual(values = extended_palette)

celltype = read.csv("export/Mye_zhushi.csv",header = F) #è‡ªå·±ç…§ç€DotPlotå›¾å¡«çš„
celltype
new.cluster.ids <- celltype$V2
names(new.cluster.ids) <- levels(obj_mye)
obj_mye = RenameIdents(obj_mye, new.cluster.ids)
obj_mye$celltype = Idents(obj_mye)



genes = read.table("plot/Mye/makers.txt", header=F, sep="\t",comment.char = "", check.names =FALSE)
colnames(genes) = c("cluster","gene")

p = jjDotPlot(object = obj_mye,
          gene = genes$gene,
          anno = T,
          plot.margin = c(3,1,1,1),
          point.geom = F,
          tile.geom = T,
          id = "celltype",#çºµåæ ‡
          dot.col = c("#edf8b1","#2c7fb8"),
          legend.position = "none"#éšè—å›¾ä¾‹
          )

pdf(file = "plot/Mye/æ³¨é‡Šåç»†èƒç±»å‹çš„çƒ­å›¾.pdf",width = 15,height = 10)
p
dev.off


#æ³¨é‡Šå›¾
p1 = clusterCornerAxes(object = obj_mye,
                  reduction = 'umap',
                  noSplit = T,#ä¸ç»„
                  clusterCol = 'celltype',
                  cellLabel = T,#è®¾ç½®äº†åˆ™åœ¨å›¾ä¸­æ ‡å‡ºæ¥
                  cellLabelSize = 5,#ç»†èƒåçš„å¤§å°
                  pSize = 0.1,
                  arrowType='open',#åˆ†å¼€çš„ç®­å¤´
                  show.legend = T, #åˆ é™¤å›¾ä¾‹
                  
                  ) +
scale_color_manual(values = extended_palette)
p1

p0 + p1

pdf(file = "plot/Mye/UMAP_.pdf",width = 15,height = 10)
p0 + p1
dev.off





```

## å±•ç¤ºæŸä¸ªåŸºå› çš„è¡¨è¾¾æƒ…å†µ
```{r}
genes = c("SPP1")

featureCornerAxes(object =obj_mye,reduction = 'umap',
                  groupFacet ="category",
                  relLength = 0.5,
                  relDist = 0.2,
                  #axes = 'one',
                  features = genes,
                  minExp = 0,maxExp = 6,
                  low ="#edf8b1" ,high = "#2c7fb8" ,
                  pSize = 0.1,
                
                  )

#FeaturePlot(obj_mye, features = c("S100A9","SPP1")) https://zhuanlan.zhihu.com/p/652376083
```

## å±•ç¤ºæ¯ä¸ªç»†èƒçš„topåŸºå› 
```{r}
Mye_allmarkers <- FindAllMarkers(obj_mye, #only.pos = TRUE, åªè¿”å›æ­£
                               min.pct = 0.4, #è¿‡æ»¤æ¡ä»¶ï¼Œè‡³å°‘è¦åœ¨æŸä¸ªğŸˆ¶25%ç»†èƒè¡¨è¾¾
                               #logfc.threshold = 0.25#logFC>0.25
                               )
dudu = Mye_allmarkers$cluster %in% c("Neutr_C1_S100A9","Neutr_C2_FCGR3B","Mph_C1_SPP1")
Mye_allmarkers = Mye_allmarkers[dudu,]
Mye_allmarkers[Mye_allmarkers$pct.1>0.6,]
markerVolcano(markers = Mye_allmarkers,
              topn = 5,
              labelCol = extended_palette)
```


## æ‹Ÿæ—¶åºåˆ†æ
æ„å»ºMonocle3æ‰€éœ€æ•°æ®
expression_matrixï¼šè¡Œæ˜¯geneï¼Œåˆ—æ˜¯cellçš„è¡¨è¾¾çŸ©é˜µ
cell_metadata:å¯¹åº”Seuratå¯¹è±¡çš„meta.dataä¿¡æ¯
gene_metadata:åŸºå› åç§°ä¿¡æ¯ï¼Œå¯ç”¨Gene symbol
```{r}
library(monocle3)
library(Seurat)
library(tidyverse)

expression_matrix=obj_mye@assays$RNA$data
cell_metadata=data.frame(obj_mye@meta.data)
gene_annotation=data.frame(expression_matrix[,1])
gene_annotation[,1]=row.names(gene_annotation)
colnames(gene_annotation)=c("gene_short_name")
##æ„å»ºMonocle3 cdså¯¹è±¡
cds = new_cell_data_set(expression_data = expression_matrix,
                        cell_metadata = cell_metadata,
                        gene_metadata = gene_annotation)

#é¢„å¤„ç†ï¼Œç›¸å½“äºSeuratæµç¨‹normalizeè¿‡ç¨‹
#countsæ•°æ®é€‰æ‹©norm_method=c("log")
#dataæ•°æ®é€‰æ‹©norm_method=c("none")
cds<-preprocess_cds(cds,num_dim=50,norm_method=c("none"))

#å»é™¤æ‰¹æ¬¡æ•ˆåº”,å¤šä¸ªæ ·æœ¬æ—¶å¯ä»¥é€šè¿‡æ­¤æ–¹å¼å»é™¤æ‰¹æ¬¡
cds<-align_cds(cds,alignment_group="orig.ident")

##é™ç»´ï¼Œé»˜è®¤æ˜¯"Umap"æ–¹å¼
cds<-reduce_dimension(cds,cores=5)

##èšç±»åˆ†ç¾¤ï¼Œåˆ†è¾¨ç‡è°ƒå°ï¼Œæ˜¯ä¸ºäº†è®©ç»†èƒæ˜¯ä¸€ç¾¤å¯ä»¥æ›´å¥½å±•ç¤º
cds<-cluster_cells(cds,resolution=0.0000001)

##æ‹Ÿæ—¶åº
cds<-learn_graph(cds)


##é€‰æ‹©ç‰¹å®šç»†èƒä½œä¸ºèµ·ç‚¹ï¼Œä»£ç æ¯”äº¤äº’å¼é¡µé¢æ–¹ä¾¿è®¸å¤šï¼Œä¸”ä¸ä¼šå‡ºç°é€‰ä¸­è‡ªå·±ä¸æƒ³è¦çš„ç»†èƒ
##è¿™é‡Œæˆ‘ä»¬å‡å®šä»¥Bç»†èƒä¸ºèµ·ç‚¹
myselect<-function(cds,select.classify,my_select){
cell_ids<-which(colData(cds)[,select.classify]==my_select)
closest_vertex<-
cds@principal_graph_aux[["UMAP"]]$pr_graph_cell_proj_closest_vertex
closest_vertex<-as.matrix(closest_vertex[colnames(cds),])
root_pr_nodes<-
igraph::V(principal_graph(cds)[["UMAP"]])$name[as.numeric(names
(which.max(table(closest_vertex[cell_ids,]))))]
root_pr_nodes}

cds<-order_cells(cds,root_pr_nodes=myselect(cds,select.classify='celltype',my_select="Mph_C4_CD68"))




##ä½¿ç”¨Seuratçš„UMAPä¿¡æ¯ï¼Œè¿™æ ·å¯ä»¥ä¸Seuratå¯¹è±¡çš„ç»†èƒåˆ†å¸ƒä¿æŒä¸€è‡´
#cds.embed<-cds@int_colData$reducedDims$UMAP
#int.embed<-Embeddings(obj_mye,reduction="umap")
#int.embed<-int.embed[rownames(cds.embed),]
#cds@int_colData$reducedDims$UMAP<-int.embed

# å®‰è£… ggsci åŒ…ï¼ˆå¦‚æœæœªå®‰è£…ï¼‰
install.packages("ggsci")

# åŠ è½½åŒ…
library(ggsci)
##ä¸åŒç»†èƒç±»å‹æ‹Ÿæ—¶åºæ•°å€¼
##æ‹Ÿæ—¶åºå€¼è¶Šé«˜è¡¨ç¤ºç»†èƒåˆ†åŒ–ç¨‹åº¦è¶Šé«˜ï¼Œè¿™é‡Œä»…ä¸ºæ¼”ç¤ºï¼Œå¹¶éçœŸå®åˆ†åŒ–æƒ…å†µ
p = plot_cells(cds,color_cells_by="pseudotime",
  show_trajectory_graph=T)+plot_cells(cds,
  color_cells_by="celltype",
  label_cell_groups=FALSE,
  label_leaves=FALSE,
  label_branch_points=FALSE,
  graph_label_size=1)+scale_color_manual(values=pal_jco("default",alpha=0.6)(13))

pdf(file = "plot/Mye/æ‹Ÿæ—¶åºåˆ†æ.pdf",width = 15,height = 10)
p
dev.off

genes<-c('CD19','CD4',"SPP1")
genes_cds<-cds[rowData(cds)$gene_short_name%in%genes,]
p = plot_genes_in_pseudotime(genes_cds,color_cells_by="celltype",min_expr=0.5,cell_size=1.5)+scale_color_manual(values=pal_jco("default",alpha=0.6)(13))

pdf(file = "plot/Mye/Monocle3å·®å¼‚åˆ†ææ.pdf",width = 15,height = 10)
p
dev.off
```





